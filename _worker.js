import{connect}from"cloudflare:sockets";const EXPIRE_TIMESTAMP=4102329600,DEFAULT_DLS=8,DEFAULT_REMARK_INDEX=1,DEFAULT_FILENAME=atob("WmlwVg=="),DEFAULT_PATH="/api/data",HTTP_PORTS=["8080","8880","2052","2082","2086","2095"],HTTPS_PORTS=["2053","2083","2087","2096","8443"],DEFAULT_GOS5S=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],USER_AGENTS=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"],FAKE_API_PATHS={primary:"/api/data",alternatives:["/api/v1/stream","/api/v1/analytics","/api/v1/metrics","/api/v2/events","/ws/realtime","/stream/live"]},NORMAL_API_ENDPOINTS=["/api/v1/user","/api/v1/posts","/api/v1/health","/api/v1/status","/api/version"],UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,IPV4_REGEX=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,RELAY_PATH_REGEX=/\/relay=/i,RELAY_PROTOCOL_REGEX=/\/relay:\/\//i,RELAY5_PROTOCOL_REGEX=/\/relay5:\/\//i,FETCH_PROTOCOL_REGEX=/\/fetch:\/\//i,ROUTERIP_PATH_REGEX=/\/routerip=/i,ROUTERIP_DOT_REGEX=/\/routerip\./i,PYIP_PATH_REGEX=/\/pyip=/i,BASE64_REGEX=/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i,IPV6_BRACKET_REGEX=/^\[.*\]$/,globalEncoder=new TextEncoder,globalDecoder=new TextDecoder;let inst_BotToken,inst_ChatID,inst_gatewayhostsURL,inst_userID="",inst_routerIPs=[],inst_DNS64Server="",inst_endpoints=[],inst_routes=[...DEFAULT_GOS5S],inst_addresses=[],inst_addressesapi=[],inst_addressesnotls=[],inst_addressesnotlsapi=[],inst_addressescsv=[],inst_DLS=8,inst_remarkIndex=1,inst_FileName=DEFAULT_FILENAME,inst_gatewayhosts=[],inst_httpPorts=[...HTTP_PORTS],inst_httpsPorts=[...HTTPS_PORTS],inst_link=[],inst_banKeywords=[],inst_banKeywordsRegex=null,inst_SCV="true",inst_allowInsecure="&allowInsecure=1",inst_subEmoji="true",inst_GatewayUA="",inst_dns64Cache=new Map,inst_rateLimitMap=new Map;const DNS64_CACHE_TTL=36e5,RATE_LIMIT_WINDOW=6e4;let inst_maxRequestsPerMinute=80,inst_lastRateLimitCleanup=0,isInstanceInitialized=!1;async function initializeInstance(e){if(!isInstanceInitialized){if(inst_userID=e.UUID||e.uuid||e.PASSWORD||e.pswd||"",(e.ROUTERIP||e.routerip)&&(inst_routerIPs=await processList(e.ROUTERIP||e.routerip)),inst_DNS64Server=e.DNS64||e.NAT64||"",(e.FETCH||e.RELAY)&&(inst_endpoints=await processList(e.FETCH||e.RELAY)),e.GO2RELAY&&(inst_routes=await processList(e.GO2RELAY)),e.CFPORTS&&(inst_httpsPorts=await processList(e.CFPORTS)),e.BAN_KEYWORDS&&""!==e.BAN_KEYWORDS.trim()&&(inst_banKeywords=await processList(e.BAN_KEYWORDS),inst_banKeywords.length>0)){const e=inst_banKeywords.filter((e=>e&&e.trim()));if(e.length>0){const t=e.map((e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))).join("|");inst_banKeywordsRegex=new RegExp(t,"i")}}if(e.ADD&&(inst_addresses=await processList(e.ADD)),e.ADDAPI&&(inst_addressesapi=await processList(e.ADDAPI)),e.ADDNOTLS&&(inst_addressesnotls=await processList(e.ADDNOTLS)),e.ADDNOTLSAPI&&(inst_addressesnotlsapi=await processList(e.ADDNOTLSAPI)),e.ADDCSV&&(inst_addressescsv=await processList(e.ADDCSV)),inst_DLS=Number(e.DLS)||inst_DLS,inst_remarkIndex=Number(e.CSVREMARK)||inst_remarkIndex,inst_BotToken=e.TGTOKEN||inst_BotToken,inst_ChatID=e.TGID||inst_ChatID,inst_FileName=e.SUBNAME||inst_FileName,inst_subEmoji=e.SUBEMOJI||e.EMOJI||inst_subEmoji,"0"==inst_subEmoji&&(inst_subEmoji="false"),inst_GatewayUA=e.DAILI_UA||"",e.LINK&&(inst_link=await processList(e.LINK)),inst_SCV=e.SCV||inst_SCV,inst_SCV&&"0"!=inst_SCV&&"false"!=inst_SCV?inst_SCV="true":inst_allowInsecure="",e.RATE_LIMIT){const t=Number(e.RATE_LIMIT);t>0&&(inst_maxRequestsPerMinute=t)}isInstanceInitialized=!0}}function getRandomUserAgent(){return USER_AGENTS[Math.floor(Math.random()*USER_AGENTS.length)]}function addNormalHeaders(e,t=!0){return e["X-Content-Type-Options"]="nosniff",e["X-Frame-Options"]="SAMEORIGIN",e["Referrer-Policy"]="strict-origin-when-cross-origin",t&&(e["Cache-Control"]="public, max-age=3600",e.Vary="Accept-Encoding"),e}function getGeoInfo(e){const t=e.headers.get("cf-connecting-ipv6")||e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"0.0.0.0",n=e.headers.get("cf-ray"),a=n?n.split("-")[1]:null;return{ip:t,country:e.cf?.country||e.headers.get("cf-ipcountry")||"N/A",countryRegion:e.cf?.region||e.headers.get("cf-region")||"N/A",city:e.cf?.city||e.headers.get("cf-ipcity")||"N/A",region:e.cf?.colo||a||"N/A",latitude:null!=e.cf?.latitude?String(e.cf.latitude):e.headers.get("cf-iplatitude")||"N/A",longitude:null!=e.cf?.longitude?String(e.cf.longitude):e.headers.get("cf-iplongitude")||"N/A",asOrganization:e.cf?.asOrganization||e.headers.get("x-asn")||"N/A",timezone:e.cf?.timezone||"N/A",asn:e.cf?.asn||"N/A"}}function generateFakeAPIResponse(e,t){const n=(new Date).toISOString(),a=getGeoInfo(t);switch(e){case"/api/v1/user":return{success:!0,data:{id:Math.random().toString(36).substr(2,9),username:"user_"+Math.floor(1e4*Math.random()),created_at:n,last_login:n},timestamp:n};case"/api/v1/posts":return{success:!0,data:{posts:Array.from({length:5},((e,t)=>({id:t+1,title:`Post ${t+1}`,created_at:n}))),total:5,page:1},timestamp:n};case"/api/v1/health":return{status:"healthy",uptime:Math.floor(86400*Math.random()),version:"1.2.3",timestamp:n};case"/api/v1/status":return{operational:!0,services:{api:"online",database:"online",cache:"online"},region:a.region,timestamp:n};case"/api/version":return{version:"1.2.3",build:"production",commit:Math.random().toString(36).substr(2,7),timestamp:n};default:return{error:"Not Found",message:"The requested endpoint does not exist",timestamp:n}}}function isGatewayPath(e,t){return e===t||e===FAKE_API_PATHS.primary||!!FAKE_API_PATHS.alternatives.includes(e)}function generateFakeWebSocketRejection(e="invalid_token"){return new Response(JSON.stringify({success:!1,error:e,message:"WebSocket connection requires valid authentication token",timestamp:(new Date).toISOString()}),{status:401,headers:{"Content-Type":"application/json","WWW-Authenticate":'Bearer realm="API"',"X-RateLimit-Limit":"100","X-RateLimit-Remaining":Math.floor(100*Math.random()).toString(),"X-RateLimit-Reset":String(Date.now()+36e5)}})}function generateGeoHTML(e,t=!1){const n=`\n        <tr><th>IP Address</th><td><code>${e.ip}</code></td></tr>\n        <tr><th>Country</th><td>${e.country}</td></tr>\n        <tr><th>Region</th><td>${e.countryRegion}</td></tr>\n        <tr><th>City</th><td>${e.city}</td></tr>\n        <tr><th>Data Center (Colo)</th><td>${e.region}</td></tr>\n        <tr><th>Latitude</th><td>${e.latitude}</td></tr>\n        <tr><th>Longitude</th><td>${e.longitude}</td></tr>\n        <tr><th>ASN</th><td>${e.asn}</td></tr>\n        <tr><th>Organization</th><td>${e.asOrganization}</td></tr>\n        <tr><th>Timezone</th><td>${e.timezone}</td></tr>\n    `;return t?`\n            <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                <title>IP Geolocation API</title>\n                <style>\n        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f7f9; margin: 0; padding: 20px; }\n        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n        h1, h2 { color: #007bff; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n        th { background-color: #f8f9fa; }\n        code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n        .footer { text-align: center; margin-top: 20px; font-size: 0.9em; color: #777; }\n        .api-info { margin-top: 30px; }\n        .api-info pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; }\n    </style>\n            </head>\n            <body>\n                <div class="container">\n                    <h1>IP Geolocation API</h1>\n                    <p>Your current connection details:</p>\n                    <table>${n}</table>\n                    <div class="api-info">\n                        <h2>API Usage</h2>\n                        <p>To get this information in JSON format, make a request to <code>/geo</code>.</p>\n                        <p>Example response:</p>\n                        <pre>${JSON.stringify(e,null,2)}</pre>\n                    </div>\n                    <div class="footer"><p>Powered by Cloudflare Workers.</p></div>\n                </div>\n            </body>\n            </html>\n        `:`<table style="width: 100%; margin: 0 auto; text-align: left; border: 1px solid #ddd;">${n}</table>`}function checkRateLimit(e){const t=Date.now();if(inst_rateLimitMap.size>1e4&&t-inst_lastRateLimitCleanup>6e4){inst_lastRateLimitCleanup=t;for(const[e,n]of inst_rateLimitMap.entries())t-n.timestamp>6e4&&inst_rateLimitMap.delete(e)}const n=inst_rateLimitMap.get(e);return!n||t-n.timestamp>6e4?(inst_rateLimitMap.set(e,{count:1,timestamp:t}),!0):(n.count++,n.count<=inst_maxRequestsPerMinute)}function containsBannedKeyword(e){if(!inst_banKeywords||0===inst_banKeywords.length)return!1;if(inst_banKeywordsRegex)return inst_banKeywordsRegex.test(e);const t=e.toLowerCase();for(const e of inst_banKeywords)if(e&&e.trim()&&t.includes(e.toLowerCase()))return!0;return!1}export default{async fetch(e,t,n){isInstanceInitialized||await initializeInstance(t);try{if(!checkRateLimit(e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||"unknown"))return new Response("Too Many Requests",{status:429,headers:{"Content-Type":"text/plain; charset=UTF-8","Retry-After":"60"}});const n=e.headers.get("User-Agent")||"null",a=n.toLowerCase();if(!inst_userID||!isValidUUID(inst_userID))return new Response("Please configure your UUID variable, or try redeploying to check if the variable is effective.",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});let s=inst_routerIPs.length>0?inst_routerIPs[Math.floor(Math.random()*inst_routerIPs.length)]:"",r=inst_endpoints.length>0?inst_endpoints[Math.floor(Math.random()*inst_endpoints.length)]:"",o=!!t.FETCH||r.toLowerCase().includes("fetch://");r&&(r=r.split("//")[1]||r);let i={},l=!1,c="false";if(r)try{i=addressParser(r),c=t.RROUTERIP||"false",l=!0}catch(e){c=t.RROUTERIP||!s?"true":"false",l=!1}else c=t.RROUTERIP||!s?"true":"false";const d=e.headers.get("Upgrade"),u=new URL(e.url);if(d&&"websocket"===d){if(inst_GatewayUA&&""!==inst_GatewayUA.trim()){const t=(e.headers.get("App-Client")||"").toLowerCase(),n=inst_GatewayUA.toLowerCase();if(!a.includes(n)&&!t.includes(n))return new Response("Forbidden: Access Denied via Restriction",{status:403,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}if(!isGatewayPath(u.pathname.toLowerCase(),"/api/data"))return generateFakeWebSocketRejection("invalid_endpoint");let t=u.searchParams.get("relay")||u.searchParams.get("fetch")||r,n=!!u.searchParams.get("fetch")||o,c=u.searchParams.has("globalgateway")?["all in"]:inst_routes,d=s,p=l,h=i;if(RELAY_PATH_REGEX.test(u.pathname))t=u.pathname.split("y=")[1];else if(RELAY_PROTOCOL_REGEX.test(u.pathname)||RELAY5_PROTOCOL_REGEX.test(u.pathname)||FETCH_PROTOCOL_REGEX.test(u.pathname)){if(n=u.pathname.includes("fetch://"),t=u.pathname.split("://")[1].split("#")[0],t.includes("@")){const e=t.lastIndexOf("@");let n=t.substring(0,e).replaceAll("%3D","=");BASE64_REGEX.test(n)&&!n.includes(":")&&(n=atob(n)),t=`${n}@${t.substring(e+1)}`}c=["all in"]}if(t)try{h=addressParser(t),p=!0}catch(e){p=!1}else p=!1;return u.searchParams.has("routerip")?(d=u.searchParams.get("routerip"),p=!1):ROUTERIP_PATH_REGEX.test(u.pathname)?(d=u.pathname.toLowerCase().split("/routerip=")[1],p=!1):ROUTERIP_DOT_REGEX.test(u.pathname)?(d=`routerip.${u.pathname.toLowerCase().split("/routerip.")[1]}`,p=!1):PYIP_PATH_REGEX.test(u.pathname)&&(d=u.pathname.toLowerCase().split("/pyip=")[1],p=!1),await dataStreamHandler(e,{userID:inst_userID,routes:c,enableRouting:p,enableDataFetch:n,parsedEndpointAddress:h,routerIP:d})}{let s="/api/data",r="false";u.searchParams.has("notls")&&(r="true");const i=["routerip","relay","fetch"];for(const e of i)if(u.searchParams.has(e)){const t=u.searchParams.get(e),n=u.searchParams.has("globalgateway");s="routerip"===e?`/${e}=${t}`:n?`/?${e}=${t}&globalgateway`:`/?${e}=${t}`,c="false";break}const l=u.pathname.toLowerCase();if(NORMAL_API_ENDPOINTS.includes(l)){const t=generateFakeAPIResponse(l,e),n=t.error?404:200;return new Response(JSON.stringify(t,null,2),{status:n,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.2.3","X-Request-ID":Math.random().toString(36).substr(2,16)})})}if("/"==l){if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await linkFetcher(t.URL,u);const n=generateGeoHTML(getGeoInfo(e),!0);return new Response(n,{status:200,headers:addNormalHeaders({"Content-Type":"text/html; charset=UTF-8"})})}if("/geo"===l){const t=getGeoInfo(e);return new Response(JSON.stringify(t,null,2),{status:200,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*"}})}if(l==`/${inst_userID}/config.json`){let a=u.searchParams.has("sub")&&""!==u.searchParams.get("sub")?u.searchParams.get("sub").toLowerCase():t.SUB||"";return await apiConfig(inst_userID,e.headers.get("Host"),a,n,c,u,t,{routerIPs:inst_routerIPs,endpoints:inst_endpoints,routes:inst_routes,enableDataFetch:o})}if("/getusage"!==l&&l!==`/${inst_userID}/getusage`){if(u.pathname==`/${inst_userID}`){let s=u.searchParams.has("sub")&&""!==u.searchParams.get("sub")?u.searchParams.get("sub").toLowerCase():t.SUB||"";const r=await renderPage(inst_userID,e.headers.get("Host"),s,n,c,u,t,e),o=Date.now(),i=new Date(o);i.setHours(0,0,0,0);const l=Math.floor((o-i.getTime())/864e5*24*1099511627776/2);let d=l,p=l,h=26388279066624;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{const e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL);h=t.CF_ALL?Number(t.CF_ALL):1e5;d=h-e,p=e}catch(e){}return a&&a.includes("mozilla")?new Response(r,{status:200,headers:addNormalHeaders({"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${h}; expire=4102329600`,"Cache-Control":"no-store"},!1)}):new Response(r,{status:200,headers:addNormalHeaders({"Content-Disposition":`attachment; filename=${inst_FileName}; filename*=utf-8''${encodeURIComponent(inst_FileName)}`,"Profile-Update-Interval":"6","Profile-web-page-url":e.url.includes("?")?e.url.split("?")[0]:e.url,"Subscription-Userinfo":`upload=${d}; download=${p}; total=${h}; expire=4102329600`},!1)})}if(isGatewayPath(l,s)){const e={success:!0,message:"Data endpoint ready",version:"1.0.0",timestamp:(new Date).toISOString(),endpoints:{websocket:"wss://example.com/api/data",status:"/api/v1/status",health:"/api/v1/health"}};return new Response(JSON.stringify(e,null,2),{status:200,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.0.0","X-Content-Type-Options":"nosniff"})})}{if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await linkFetcher(t.URL,u);const n=`\n                        <!DOCTYPE html>\n                        <html lang="en">\n                        <head>\n                            <meta charset="UTF-8">\n                            <title>403 Forbidden</title>\n                            <style>\n                                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }\n                                .container { max-width: 800px; margin: 2em auto; padding: 1em; }\n                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n                                th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n                                th { background-color: #f8f9fa; }\n                                code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n                            </style>\n                        </head>\n                        <body>\n                            <div class="container">\n                                <h1>403 Forbidden</h1>\n                                <p>Access Denied: You do not have permission to access this resource.</p>\n                                <hr>\n                                ${generateGeoHTML(getGeoInfo(e),!1).replace("<table",'<table style="width:100%;"')}\n                            </div>\n                        </body>\n                        </html>\n                    `;return new Response(n,{status:403,headers:{"Content-Type":"text/html; charset=UTF-8"}})}}try{let e=0,n=1e5;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL),n=t.CF_ALL?Number(t.CF_ALL):1e5}catch(t){const a=Date.now(),s=new Date(a);s.setHours(0,0,0,0);const r=(a-s.getTime())/864e5,o=Math.floor(n*r*.5);e=Math.max(0,n-o)}else{const t=Date.now(),a=new Date(t);a.setHours(0,0,0,0);const s=(t-a.getTime())/864e5,r=Math.floor(n*s*.5);e=Math.max(0,n-r)}const a=n-e;return new Response(JSON.stringify({success:!0,data:{total:n,used:a,remaining:e,percentage:(a/n*100).toFixed(2)+"%"},timestamp:(new Date).toISOString()},null,2),{status:200,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}catch(e){return new Response(JSON.stringify({success:!1,error:e.message||"Unknown error",timestamp:(new Date).toISOString()},null,2),{status:500,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}}}catch(e){return new Response(`Internal Server Error: ${e.message}`,{status:500,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}}};async function dataStreamHandler(e,t){const n=new WebSocketPair,[a,s]=Object.values(n);s.accept();let r="",o="";const i=(e,t)=>{},l=e.headers.get("sec-websocket-protocol")||"",c=makeReadableWebSocketStream(s,l,i);let d={value:null},u=null,p=!1;return c.pipeTo(new WritableStream({async write(e,n){if(p&&u)return u(e);if(d.value){const t=d.value.writable.getWriter();return await t.write(e),void t.releaseLock()}const{hasError:a,message:l,addressType:c,portRemote:h=443,addressRemote:m="",rawDataIndex:f,zipvVersion:b=new Uint8Array([0,0]),isUDP:g}=processDataHeader(e,t.userID);if(r=m,o=`${h}--${Math.random()} ${g?"udp ":"tcp "} `,a)throw new Error(l);if(g){if(53!==h)throw new Error("UDP relay only enabled for port 53");p=!0}const y=new Uint8Array([b[0],0]),w=e.slice(f);if(p){const{write:e}=await handleUDPOutBound(s,y,i);return u=e,void u(w)}if(containsBannedKeyword(m))throw new Error(`Blocked connection to ${m}:${h}`);handleDataOut(d,c,m,h,w,s,y,i,t)},close(){},abort(e){}})).catch((e=>{})),new Response(null,{status:101,webSocket:a})}async function handleDataOut(e,t,n,a,s,r,o,i,l){const{routes:c,enableRouting:d,enableDataFetch:u,parsedEndpointAddress:p,routerIP:h}=l;async function m(n,a,r=!1,o=!1,l){const c=r?o?await dataConnect(n,a,i,l):await secureConnect(t,n,a,i,l):connect({hostname:n,port:a});if(!r)try{await Promise.race([c.opened,new Promise(((e,t)=>setTimeout((()=>t(new Error("Connection timeout"))),3e3)))])}catch(e){try{c.close()}catch(e){}throw new Error(`Direct connection failed: ${e.message}`)}e.value=c;const d=c.writable.getWriter();return await d.write(s),d.releaseLock(),c}async function f(){if(!g){const e=`[${await addressResolver(n)}]`;b=await m(e,443,!1,!1,null)}b.closed.catch((e=>{})).finally((()=>{safeCloseWebSocket(r)})),remoteSocketToWS(b,r,o,null,i)}let b,g=!1;c.length>0&&d&&(g=await async function(e){return!(!c.includes(atob("YWxsIGlu"))&&!c.includes(atob("Kg==")))||c.some((t=>{let n=t.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(e)}))}(n));try{b=await m(n,a,g,u,p)}catch(e){if(1!==t||g||u)throw e;try{let e=await addressResolver(n);e.startsWith("[")&&e.endsWith("]")&&(e=e.slice(1,-1)),b=await m(e,a,!1,!1,null)}catch(t){throw e}}remoteSocketToWS(b,r,o,(async function(){if(d)b=await m(n,a,!0,u,p);else{let e=h,t=a;e&&""!=e?e.includes("]:")?(t=e.split("]:")[1]||a,e=e.split("]:")[0]+"]"||e):2===e.split(":").length&&(t=e.split(":")[1]||a,e=e.split(":")[0]||e):e=atob("RGF0YUxpbmtlcklQLmNtTGl1U3Nzcy5OZXQ="),e.includes(".tp")&&(t=e.split(".tp")[1].split(".")[0]||a),b=await m(e.toLowerCase()||n,t,!1,!1,null)}remoteSocketToWS(b,r,o,f,i)}),i)}function makeReadableWebSocketStream(e,t,n){let a=!1;return new ReadableStream({start(n){e.addEventListener("message",(e=>{if(a)return;const t=e.data;n.enqueue(t)})),e.addEventListener("close",(()=>{safeCloseWebSocket(e),a||n.close()})),e.addEventListener("error",(e=>{n.error(e)}));const{earlyData:s,error:r}=base64ToArrayBuffer(t);r?n.error(r):s&&n.enqueue(s)},pull(e){},cancel(t){a||(a=!0,safeCloseWebSocket(e))}})}function processDataHeader(e,t){const n=e instanceof Uint8Array?e:new Uint8Array(e);if(n.byteLength<24)return{hasError:!0,message:"invalid data"};const a=n.subarray(0,1);let s=!1,r=!1;const o=n.subarray(1,17);if(s=stringify(o)===t,!s)return{hasError:!0,message:`invalid user ${o}`};const i=n[17],l=n[18+i];if(1!==l){if(2!==l)return{hasError:!0,message:`command ${l} is not support, command 01-tcp,02-udp,03-mux`};r=!0}const c=18+i+1,d=new DataView(n.buffer,n.byteOffset+c,2).getUint16(0);let u=c+2;const p=n[u];let h=0,m=u+1,f="";switch(p){case 1:h=4,f=n.subarray(m,m+h).join(".");break;case 2:h=n[m],m+=1,f=globalDecoder.decode(n.subarray(m,m+h));break;case 3:h=16;const e=new DataView(n.buffer,n.byteOffset+m,h),t=[];for(let n=0;n<8;n++)t.push(e.getUint16(2*n).toString(16));f=t.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return f?{hasError:!1,addressRemote:f,addressType:p,portRemote:d,rawDataIndex:m+h,zipvVersion:a,isUDP:r}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function remoteSocketToWS(e,t,n,a,s){let r=n,o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){o=!0,t.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket.readyState is not open, maybe close"),r?(t.send(await new Blob([r,e]).arrayBuffer()),r=null):t.send(e)},close(){},abort(e){}})).catch((e=>{safeCloseWebSocket(t)})),!1===o&&a&&a()}function base64ToArrayBuffer(e){if(!e)return{earlyData:void 0,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{earlyData:void 0,error:e}}}function isValidUUID(e){return UUID_REGEX.test(e)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){}}const byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase()}function stringify(e,t=0){const n=unsafeStringify(e,t);if(!isValidUUID(n))throw TypeError(`Generated UUID does not conform to specification ${n}`);return n}async function handleUDPOutBound(e,t,n){let a=!1;const s=new TransformStream({start(e){},transform(e,t){for(let n=0;n<e.byteLength;){const a=e.slice(n,n+2),s=new DataView(a).getUint16(0),r=new Uint8Array(e.slice(n+2,n+2+s));n=n+2+s,t.enqueue(r)}},flush(e){}});s.readable.pipeTo(new WritableStream({async write(n){const s=await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:n}),r=await s.arrayBuffer(),o=r.byteLength,i=new Uint8Array([o>>8&255,255&o]);e.readyState===WS_READY_STATE_OPEN&&(a?e.send(await new Blob([i,r]).arrayBuffer()):(e.send(await new Blob([t,i,r]).arrayBuffer()),a=!0))}})).catch((e=>{}));const r=s.writable.getWriter();return{write(e){r.write(e)}}}async function handleDNSQuery(e,t,n,a){try{let a=n;const s=connect({hostname:"8.8.4.4",port:53}),r=s.writable.getWriter();await r.write(e),r.releaseLock(),await s.readable.pipeTo(new WritableStream({async write(e){t.readyState===WS_READY_STATE_OPEN&&(a?(t.send(await new Blob([a,e]).arrayBuffer()),a=null):t.send(e))},close(){},abort(e){}}))}catch(e){}}async function secureConnect(e,t,n,a,s){const{username:r,password:o,hostname:i,port:l}=s,c=connect({hostname:i,port:l}),d=c.writable.getWriter(),u=c.readable.getReader();try{const s=new Uint8Array([5,2,0,2]);await d.write(s);let i,l=(await u.read()).value;if(5!==l[0])throw new Error("Version mismatch");if(255===l[1])throw new Error("Server does not accept any authentication methods");if(2===l[1]){if(a("Server requires authentication"),!r||!o)throw new Error("Please provide username and password");const e=new Uint8Array([1,r.length,...globalEncoder.encode(r),o.length,...globalEncoder.encode(o)]);if(await d.write(e),l=(await u.read()).value,1!==l[0]||0!==l[1])throw new Error("Server authentication failed")}switch(e){case 1:i=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:i=new Uint8Array([3,t.length,...globalEncoder.encode(t)]);break;case 3:i=new Uint8Array([4,...t.split(":").flatMap((e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)]))]);break;default:throw new Error(`Unsupported address type: ${e}`)}const p=new Uint8Array([5,1,0,...i,n>>8,255&n]);if(await d.write(p),l=(await u.read()).value,0!==l[1])throw new Error(`Connection failed, error code: ${l[1]}`);return a("Connection established"),d.releaseLock(),u.releaseLock(),c}catch(e){try{d.releaseLock()}catch(e){}try{u.releaseLock()}catch(e){}try{c.close()}catch(e){}throw e}}async function dataConnect(e,t,n,a){const{username:s,password:r,hostname:o,port:i}=a,l=await connect({hostname:o,port:i}),c=atob("Q09OTkVDVA=="),d=["https://www.google.com/","https://www.bing.com/","https://duckduckgo.com/","https://yandex.com/","https://www.baidu.com/",""],u=d[Math.floor(Math.random()*d.length)];let p=`${c} ${e}:${t} HTTP/1.1\r\n`;if(p+=`Host: ${e}:${t}\r\n`,s&&r){p+=`Proxy-Authorization: Basic ${btoa(`${s}:${r}`)}\r\n`}p+=`User-Agent: ${getRandomUserAgent()}\r\n`,p+="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\r\n",p+="Accept-Language: en-US,en;q=0.9\r\n",p+="Accept-Encoding: gzip, deflate, br\r\n",p+="Upgrade-Insecure-Requests: 1\r\n",p+="Sec-Fetch-Dest: document\r\n",p+="Sec-Fetch-Mode: navigate\r\n",p+="Sec-Fetch-Site: none\r\n",p+="Sec-Fetch-User: ?1\r\n",p+="Priority: u=0, i\r\n",u&&(p+=`Referer: ${u}\r\n`),p+="Proxy-Connection: Keep-Alive\r\n",p+="Connection: Keep-Alive\r\n",p+="\r\n";const h=l.writable.getWriter(),m=l.readable.getReader();try{await h.write(globalEncoder.encode(p))}catch(e){try{h.releaseLock()}catch(e){}try{m.releaseLock()}catch(e){}try{l.close()}catch(e){}throw new Error(`Failed to send request: ${e.message}`)}let f=new Uint8Array(0),b=-1,g=0;try{for(;-1===b&&g<8192;){const{value:e,done:t}=await m.read();if(t)throw new Error("Connection interrupted");const n=new Uint8Array(f.length+e.length);n.set(f),n.set(e,f.length),f=n,g=f.length;const a=f.findIndex(((e,t)=>t<f.length-3&&13===f[t]&&10===f[t+1]&&13===f[t+2]&&10===f[t+3]));-1!==a&&(b=a+4)}if(-1===b)throw new Error("Invalid response format: header end marker not found");const e=globalDecoder.decode(f.slice(0,b)),t=e.split("\r\n")[0].match(/HTTP\/\d\.\d\s+(\d+)/);if(!t)throw new Error("Invalid response format: cannot parse status line");const n=parseInt(t[1]);if(n<200||n>=300)throw new Error(`Connection failed: HTTP ${n} - ${e.split("\r\n")[0]}`);if(b<f.length){const e=f.slice(b);let t=!1;const n=new ReadableStream({start(n){t||(n.enqueue(e),t=!0)},async pull(e){try{const{value:t,done:n}=await m.read();n?e.close():e.enqueue(t)}catch(t){e.error(t)}},cancel(){try{m.releaseLock()}catch(e){}}});return m.releaseLock(),{writable:l.writable,readable:n,closed:l.closed,opened:l.opened,close:()=>l.close()}}return m.releaseLock(),l}catch(e){try{h.releaseLock()}catch(e){}try{m.releaseLock()}catch(e){}try{l.close()}catch(e){}throw new Error(`Failed to process response: ${e.message}`)}}function addressParser(e){if(!e||"string"!=typeof e)throw new Error("Invalid address format: address cannot be empty");const t=e.lastIndexOf("@");let n,a,s,r,[o,i]=-1===t?[e,void 0]:[e.substring(t+1),e.substring(0,t)];if(i){const e=i.split(":");if(2!==e.length)throw new Error('Invalid address format: authentication part must be in "username:password" form');[n,a]=e}const l=o.split(":");if(l.length>2&&o.includes("]:")?(r=Number(o.split("]:")[1].replace(/[^\d]/g,"")),s=o.split("]:")[0]+"]"):2===l.length?(r=Number(l.pop().replace(/[^\d]/g,"")),s=l.join(":")):(r=80,s=o),isNaN(r)||r<1||r>65535)throw new Error("Invalid address format: port number must be between 1-65535");if(s.includes(":")&&!IPV6_BRACKET_REGEX.test(s))throw new Error("Invalid address format: IPv6 address must be enclosed in square brackets, e.g. [2001:db8::1]");return{username:n,password:a,hostname:s,port:r}}async function linkFetcher(e,t){const n=await processList(e),a=n[Math.floor(Math.random()*n.length)];let s=new URL(a),r=s.protocol.slice(0,-1)||"https",o=s.hostname,i=s.pathname,l=s.search;"/"==i.charAt(i.length-1)&&(i=i.slice(0,-1)),i+=t.pathname;let c=`${r}://${o}${i}${l}`,d=await fetch(c),u=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return u.headers.set("X-New-URL",c),u}let subParams=["sub","base64","b64"];async function processList(e){var t=e.replace(/[\t"'\r\n]+/g,",").replace(/,+/g,",");return","==t.charAt(0)&&(t=t.slice(1)),","==t.charAt(t.length-1)&&(t=t.slice(0,t.length-1)),t.split(",")}function isValidIPv4(e){return IPV4_REGEX.test(e)}async function addressResolver(e){const t=e.toLowerCase(),n=inst_dns64Cache.get(t);if(n&&Date.now()-n.timestamp<DNS64_CACHE_TTL)return n.ipv6;const a=atob("REFUQUxpbmtlcklQLmNtTGl1U3Nzcy5OZXQ=");if(!inst_DNS64Server)try{const e=await fetch(atob("aHR0cHM6Ly8xLjEuMS4xL2Rucy1xdWVyeT9uYW1lPW5hdDY0LmNtbGl1c3Nzcy5uZXQmdHlwZT1UWFQ="),{headers:{Accept:"application/dns-json"}});if(!e.ok)return a;const t=((await e.json()).Answer||[]).filter((e=>16===e.type)).map((e=>e.data));if(0===t.length)return a;let n=t[0];n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1));const s=n.replace(/\\010/g,"\n").split("\n").filter((e=>e.trim()));if(0===s.length)return a;inst_DNS64Server=s[Math.floor(Math.random()*s.length)]}catch(e){return a}function s(e){return e.includes(":")&&/^[0-9a-fA-F:]+$/.test(e)}try{if(s(e))return e;const n=function(e){const t=e.split(".");return 4===t.length&&t.every((e=>{const t=parseInt(e,10);return t>=0&&t<=255&&e===t.toString()}))}(e)?e:await async function(e){const t=`https://1.1.1.1/dns-query?name=${e}&type=A`,n=await fetch(t,{headers:{Accept:"application/dns-json"}});if(!n.ok)throw new Error("Query failed");const a=((await n.json()).Answer||[]).filter((e=>1===e.type)).map((e=>e.data));if(0===a.length)throw new Error("IPv4 address not found");return a[Math.floor(Math.random()*a.length)]}(e),r=inst_DNS64Server.endsWith("/96")?function(e){const t=e.split(".");if(4!==t.length)throw new Error("Invalid IPv4 address");const n=t.map((e=>{const t=parseInt(e,10);if(t<0||t>255)throw new Error("Invalid IPv4 address segment");return t.toString(16).padStart(2,"0")}));return inst_DNS64Server.split("/96")[0]+n[0]+n[1]+":"+n[2]+n[3]}(n):await async function(e){const t=connect({hostname:s(inst_DNS64Server)?`[${inst_DNS64Server}]`:inst_DNS64Server,port:53}),n=t.writable.getWriter(),a=t.readable.getReader();try{const t=function(e){const t=new ArrayBuffer(512),n=new DataView(t);let a=0;n.setUint16(a,Math.floor(65536*Math.random())),a+=2,n.setUint16(a,256),a+=2,n.setUint16(a,1),a+=2,n.setUint16(a,0),a+=6;for(const t of e.split(".")){n.setUint8(a++,t.length);for(let e=0;e<t.length;e++)n.setUint8(a++,t.charCodeAt(e))}return n.setUint8(a++,0),n.setUint16(a,28),a+=2,n.setUint16(a,1),a+=2,new Uint8Array(t,0,a)}(e),s=new Uint8Array(t.length+2);s[0]=t.length>>8,s[1]=255&t.length,s.set(t,2),await n.write(s);const r=await async function(e){const t=[];let n=0,a=null;for(;;){const{value:s,done:r}=await e.read();if(r)break;if(t.push(s),n+=s.length,null===a&&n>=2&&(a=t[0][0]<<8|t[0][1]),null!==a&&n>=a+2)break}const s=new Uint8Array(n);let r=0;for(const e of t)s.set(e,r),r+=e.length;return s.slice(2)}(a),o=function(e){const t=new DataView(e.buffer);let n=12;for(;0!==t.getUint8(n);)n+=t.getUint8(n)+1;n+=5;const a=[],s=t.getUint16(6);for(let e=0;e<s;e++){if(192==(192&t.getUint8(n)))n+=2;else{for(;0!==t.getUint8(n);)n+=t.getUint8(n)+1;n++}const e=t.getUint16(n);n+=2,n+=6;const s=t.getUint16(n);if(n+=2,28===e&&16===s){const e=[];for(let a=0;a<8;a++)e.push(t.getUint16(n+2*a).toString(16));a.push(e.join(":"))}n+=s}return a}(r);return o.length>0?o[0]:"IPv6 address not found"}finally{await n.close(),await a.cancel()}}(n+atob("LmlwLjA5MDIyNy54eXo="));return s(r)&&r!==a&&(inst_dns64Cache.set(t,{ipv6:r,timestamp:Date.now()}),inst_dns64Cache.size>1e3&&inst_dns64Cache.delete(inst_dns64Cache.keys().next().value)),s(r)?r:a}catch(e){return a}}async function getUsage(e,t,n,a,s=1e5){try{if(!e){if(!t||!n)throw new Error("Missing required authentication info: email and apikey cannot be empty");e=await async function(e,t){const n=await fetch("https://api.cloudflare.com/client/v4/accounts",{method:"GET",headers:{"Content-Type":"application/json","X-AUTH-EMAIL":e,"X-AUTH-KEY":t}});if(!n.ok){const e=await n.text();throw new Error(`Cloudflare API request failed: ${n.status} ${n.statusText} - ${e}`)}const a=await n.json();let s=0,r=!1;if(a?.result&&a.result.length>1){const t=e.toLowerCase();for(let e=0;e<a.result.length;e++)if((a.result[e]?.name?.toLowerCase()||"").startsWith(t)){s=e,r=!0;break}}else a?.result&&1===a.result.length&&(r=!0);const o=a?.result?.[s]?.id;if(!o)throw new Error("Valid account ID not found, please check API permissions");return o}(t,n)}const r=new Date,o=r.toISOString();r.setUTCHours(0,0,0,0);const i=r.toISOString();let l;if(n&&t)l={"Content-Type":"application/json","X-AUTH-EMAIL":t,"X-AUTH-KEY":n};else{if(!a)throw new Error("Missing authentication info: need (email+apikey) or apitoken");l={"Content-Type":"application/json",Authorization:`Bearer ${a}`}}const c=await fetch("https://api.cloudflare.com/client/v4/graphql",{method:"POST",headers:l,body:JSON.stringify({query:"query getBillingMetrics($accountId: String!, $filter: AccountWorkersInvocationsAdaptiveFilter_InputObject) {\n                    viewer {\n                        accounts(filter: {accountTag: $accountId}) {\n                            pagesFunctionsInvocationsAdaptiveGroups(limit: 1000, filter: $filter) {\n                                sum { requests }\n                            }\n                            workersInvocationsAdaptive(limit: 10000, filter: $filter) {\n                                sum { requests }\n                            }\n                        }\n                    }\n                }",variables:{accountId:e,filter:{datetime_geq:i,datetime_leq:o}}})});if(!c.ok){const e=await c.text();throw new Error(`GraphQL API request failed: ${c.status} - ${e}`)}const d=await c.json();if(d.errors&&d.errors.length>0){const e=d.errors[0].message||"Unknown GraphQL error";throw new Error(`GraphQL error: ${e}`)}const u=d?.data?.viewer?.accounts?.[0];if(!u)return 0;const p=(u?.pagesFunctionsInvocationsAdaptiveGroups||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0),h=(u?.workersInvocationsAdaptive||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0);return Math.max(0,(Number(s)||1e5)-(p+h))}catch(e){throw e}}const hunxiao=atob("ZG14bGMzTT0=");async function apiConfig(e,t,n,a,s,r,o,i){const{routerIPs:l,endpoints:c,routes:d,enableDataFetch:u}=i,p=c.map((e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e)).filter((e=>""!==e));let h="auto";c.length>0?h=u?"fetch":"relay":l.length>0?h="routerip":"true"==s&&(h="auto");let m=t;const f={timestamp:(new Date).toISOString(),config:{HOST:t,KEY:{UUID:e.toLowerCase()||null},SCV:inst_SCV},routerip:{RequestRouterIP:s,GO2CF:h,List:{Router_IP:l.filter((e=>""!==e)),RELAY:u?[]:p,FETCH:u?p:[]},GO2RELAY:d.includes("all in")||d.includes("*")?["all in"]:d},sub:{SUBNAME:inst_FileName,SUB:n&&"local"!=n?n:"local",ADD:inst_addresses,ADDNOTLS:inst_addressesnotls,ADDAPI:inst_addressesapi,ADDNOTLSAPI:inst_addressesnotlsapi,ADDCSV:inst_addressescsv,DLS:inst_DLS,CSVREMARK:inst_remarkIndex},link:{v2:`${atob(hunxiao)}://${e.toLowerCase()}@${m}:443?encryp${atob("dGlvbj0=")}none&security=tls&sni=${m}&fp=chrome&type=ws&host=${t}&path=${encodeURIComponent("/api/data")+inst_allowInsecure}&fragment=${encodeURIComponent("1,40-60,30-50,tlshello")}#${encodeURIComponent(inst_FileName)}`},KV:!!o.KV,UA:a||null};return new Response(JSON.stringify(f,null,2),{headers:{"access-control-allow-origin":"*","Content-Type":"application/json","Cache-Control":"no-cache"}})}async function renderPage(e,t,n,a,s,r,o,i){if(n){const u=n.match(/^(?:https?:\/\/)?([^\/]+)/);u&&(n=u[1]);const p=await processList(n);p.length>1&&(n=p[0])}else if(inst_addresses.length+inst_addressesapi.length+inst_addressesnotls.length+inst_addressesnotlsapi.length+inst_addressescsv.length==0){let h=["104.16.0.0/13"];function l(e){const[t,n]=e.split("/"),a=t.split(".").map(Number),s=32-parseInt(n,10),r=Math.pow(2,s)-1,o=Math.floor(Math.random()*r);return a.map(((e,t)=>t<2?e:2===t?(e&255<<s-8)+(o>>8&255):(e&255<<s)+(255&o))).join(".")}inst_addresses.push("127.0.0.1:1234#CFnat");let m=1;if(t.includes("worker")||t.includes("notls")){const f=inst_httpPorts.concat("80");inst_addressesnotls.push(...h.map((e=>l(e)+":"+f[Math.floor(Math.random()*f.length)]+"#CF Random Node"+String(m++).padStart(2,"0"))))}else{const b=inst_httpsPorts.concat("443");inst_addresses.push(...h.map((e=>l(e)+":"+b[Math.floor(Math.random()*b.length)]+"#CF Random Node"+String(m++).padStart(2,"0"))))}}const c=a.toLowerCase();let d="";if(t.includes(".workers.dev")){if(inst_gatewayhostsURL&&(!inst_gatewayhosts||0==inst_gatewayhosts.length))try{const g=await fetch(inst_gatewayhostsURL);if(!g.ok)return;const y=await g.text(),w=y.split("\n").filter((e=>""!==e.trim()));inst_gatewayhosts=inst_gatewayhosts.concat(w)}catch(E){}0!=inst_gatewayhosts.length&&(d=inst_gatewayhosts[Math.floor(Math.random()*inst_gatewayhosts.length)]+"/")}if(c.includes("mozilla")&&!subParams.some((e=>r.searchParams.has(e)))){return config_Html(d,getGeoInfo(i))}return""}function config_Html(e="",t){return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title id="pageTitle">Service Configuration</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">\n</head>\n<body style="font-family: 'Noto Sans SC', sans-serif; background-color: #f4f7f9; color: #333333; line-height: 1.7;">\n    <div class="container py-4">\n        <div class="card mb-4 rounded-3 shadow position-relative">\n            <div class="card-body text-center p-4">\n                <h1 id="pageHeader" class="display-4 fw-bold text-primary mb-0">üîß Service Configuration</h1>\n            </div>\n        </div>\n        <div id="loading" class="d-flex flex-column align-items-center justify-content-center min-vh-50 text-muted">\n            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>\n            <p>Loading configuration information...</p>\n        </div>\n        <div id="content" class="d-none">\n            <div class="row g-4">\n                <div class="col-12">\n                    <div class="card">\n                        <div class="card-header d-flex justify-content-between align-items-center">\n                            <div class="d-flex align-items-center gap-2">\n                                <span>üìã</span><span>Subscription Links</span>\n                            </div>\n                            <button class="btn btn-primary btn-sm" onclick="openAdvancedSettings()">‚öôÔ∏è Custom Settings</button>\n                        </div>\n                        <div class="card-body">\n                            <div class="d-flex flex-column gap-3" id="subscriptionLinks"></div>\n                        </div>\n                    </div>\n                </div>\n                <div class="col-12">\n                    <div class="accordion" id="configAccordion">\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">‚öôÔ∏è Configuration Details</button>\n                            </h2>\n                            <div id="configCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light">\n                                    <div class="d-flex flex-column gap-2" id="configInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#linkCollapse">üîó Links</button>\n                            </h2>\n                            <div id="linkCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light p-0">\n                                    <div class="p-3" id="linkInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n             <div class="card mt-4">\n                <div class="card-header"><h5 class="mb-0">üìç Connection Information</h5></div>\n                <div class="card-body">${t?generateGeoHTML(t,!1):""}</div>\n            </div>\n        </div>\n    </div>\n    <div class="text-center py-3 mt-4 text-muted small border-top"><p id="userAgent"></p></div>\n    <div class="modal fade" id="advancedModal" tabindex="-1" aria-hidden="true">\n        <div class="modal-dialog modal-lg">\n            <div class="modal-content rounded-3">\n                <div class="modal-header">\n                    <h3 class="modal-title text-primary">‚öôÔ∏è Custom Subscription Settings</h3>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                </div>\n                <div class="modal-body">\n                    <div class="mb-3">\n                        <div class="form-check d-flex align-items-center mb-2">\n                            <input class="form-check-input me-2" type="checkbox" id="subEnabled">\n                            <label class="form-check-label fw-medium" for="subEnabled">üöÄ Optimized Subscription Generator</label>\n                        </div>\n                        <input type="text" id="subInput" class="form-control" placeholder="sub.google.com">\n                    </div>\n                    <div class="mb-3">\n                        <div class="form-check d-flex align-items-center mb-2">\n                            <input class="form-check-input me-2" type="checkbox" id="routeripEnabled">\n                            <label class="form-check-label fw-medium" for="routeripEnabled">üåê Router IP</label>\n                        </div>\n                        <input type="text" id="routeripInput" class="form-control" placeholder="routerip.myword.net:443">\n                    </div>\n                    <div class="mb-3">\n                        <div class="d-flex align-items-center justify-content-between mb-2">\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="relayEnabled">\n                                <label class="form-check-label fw-medium" for="relayEnabled">üîí Secure Relay</label>\n                            </div>\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="relayGlobalEnabled">\n                                <label class="form-check-label small text-muted" for="relayGlobalEnabled">Global Mode</label>\n                            </div>\n                        </div>\n                        <input type="text" id="relayInput" class="form-control" placeholder="user:password@127.0.0.1:1080">\n                    </div>\n                    <div class="mb-3">\n                        <div class="d-flex align-items-center justify-content-between mb-2">\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="fetchEnabled">\n                                <label class="form-check-label fw-medium" for="fetchEnabled">üåç Data Fetch</label>\n                            </div>\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="fetchGlobalEnabled">\n                                <label class="form-check-label small text-muted" for="fetchGlobalEnabled">Global Mode</label>\n                            </div>\n                        </div>\n                        <input type="text" id="fetchInput" class="form-control" placeholder="34.87.109.175:9443">\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>\n                    <button type="button" class="btn btn-primary" onclick="saveAdvancedSettings()">Save</button>\n                </div>\n            </div>\n        </div>\n    </div>\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"><\/script>\n    <script>\n        let configData = null;\n        document.addEventListener('DOMContentLoaded', function() { loadConfig(); });\n        async function loadConfig() {\n            try {\n                const response = await fetch(window.location.pathname + '/config.json?t=' + Date.now());\n                if (!response.ok) throw new Error('HTTP error! status: ' + response.status);\n                configData = await response.json();\n                document.getElementById('loading').classList.add('d-none');\n                document.getElementById('content').classList.remove('d-none');\n                renderSubscriptionLinks(); renderLinkInfo(); renderConfigInfo(); updatePageTitles();\n                document.getElementById('userAgent').textContent = 'User-Agent: ' + configData.UA;\n            } catch (error) { console.error('Configuration loading failed:', error); }\n        }\n        function renderSubscriptionLinks() {\n            const container = document.getElementById('subscriptionLinks');\n            const host = configData.config.HOST;\n            const uuid = configData.config.KEY.UUID;\n            const subscriptions = [{ name: 'Adaptive Subscription', suffix: '?sub', primary: true }, { name: 'Base64 Subscription', suffix: '?b64', primary: false }];\n            container.innerHTML = '';\n            const primarySub = subscriptions.find(sub => sub.primary);\n            const primaryUrl = buildSubscriptionUrl(host, uuid, primarySub.suffix);\n            const primaryCard = document.createElement('div');\n            primaryCard.className = 'card border p-3';\n            primaryCard.innerHTML = '<h4 class="card-title text-primary mb-2">' + primarySub.name + '</h4>' + '<div class="bg-light border rounded p-2 mb-2 small monospace" style="word-break: break-all; cursor: pointer;">' + primaryUrl + '</div>' + '<div class="d-flex gap-2"><button class="btn btn-primary btn-sm">üìã Copy</button></div>';\n            primaryCard.querySelector('.bg-light').addEventListener('click', () => copyText(primaryUrl));\n            primaryCard.querySelector('.btn-primary').addEventListener('click', () => copyText(primaryUrl));\n            container.appendChild(primaryCard);\n            const showMoreBtn = document.createElement('button');\n            showMoreBtn.className = 'btn btn-primary mt-2';\n            showMoreBtn.textContent = 'üìã More Formats';\n            showMoreBtn.addEventListener('click', toggleAdditionalSubscriptions);\n            container.appendChild(showMoreBtn);\n            const additionalContainer = document.createElement('div');\n            additionalContainer.className = 'd-none mt-2';\n            additionalContainer.id = 'additionalSubscriptions';\n            subscriptions.filter(sub => !sub.primary).forEach((sub, index) => {\n                const url = buildSubscriptionUrl(host, uuid, sub.suffix);\n                const card = document.createElement('div');\n                card.className = 'card border p-3';\n                card.innerHTML = '<h4 class="card-title text-primary mb-2">' + sub.name + '</h4>' + '<div class="bg-light border rounded p-2 mb-2 small monospace" style="word-break: break-all; cursor: pointer;">' + url + '</div>' + '<div class="d-flex gap-2"><button class="btn btn-primary btn-sm">üìã Copy</button></div>';\n                card.querySelector('.bg-light').addEventListener('click', () => copyText(url));\n                card.querySelector('.btn-primary').addEventListener('click', () => copyText(url));\n                additionalContainer.appendChild(card);\n            });\n            container.appendChild(additionalContainer);\n        }\n        function buildSubscriptionUrl(host, uuid, suffix) {\n            let baseUrl = 'https://${e}' + host + '/' + uuid + suffix;\n            const settings = getAdvancedSettings();\n            const params = [];\n            if (settings.subEnabled && settings.subValue) {\n                if (suffix === '?sub') baseUrl = 'https://${e}' + host + '/' + uuid + '?sub=' + encodeURIComponent(settings.subValue);\n                else params.push('sub=' + encodeURIComponent(settings.subValue));\n            }\n            if (settings.routeripEnabled && settings.routeripValue) params.push('routerip=' + encodeURIComponent(settings.routeripValue));\n            else if (settings.relayEnabled && settings.relayValue) {\n                params.push('relay=' + encodeURIComponent(settings.relayValue));\n                if (settings.relayGlobalEnabled) params.push('globalgateway');\n            } else if (settings.fetchEnabled && settings.fetchValue) {\n                params.push('fetch=' + encodeURIComponent(settings.fetchValue));\n                if (settings.fetchGlobalEnabled) params.push('globalgateway');\n            }\n            if (params.length > 0) {\n                const separator = baseUrl.includes('?') ? '&' : '?';\n                return baseUrl + separator + params.join('&');\n            }\n            return baseUrl;\n        }\n        function toggleAdditionalSubscriptions() {\n            const additionalContainer = document.getElementById('additionalSubscriptions');\n            const showMoreBtn = document.querySelector('.btn-primary.mt-2');\n            if (additionalContainer.classList.contains('d-block')) {\n                additionalContainer.classList.remove('d-block');\n                additionalContainer.classList.add('d-none');\n                showMoreBtn.textContent = 'üìã More Formats';\n            } else {\n                additionalContainer.classList.remove('d-none');\n                additionalContainer.classList.add('d-block');\n                showMoreBtn.textContent = 'üìã Hide Formats';\n            }\n        }\n        function renderLinkInfo() {\n            const container = document.getElementById('linkInfo');\n            const v2Link = configData.link.v2;\n            const v2Card = document.createElement('div');\n            v2Card.className = 'card border-start border-success border-3 p-3 mb-3';\n            v2Card.innerHTML = '<div class="fw-bold text-success h5 mb-2">v2 Link</div>' + '<div class="small monospace bg-light p-2 rounded" style="word-break: break-all; cursor: pointer;">' + v2Link + '</div>';\n            v2Card.querySelector('.bg-light').addEventListener('click', () => copyText(v2Link));\n            container.innerHTML = '';\n            container.appendChild(v2Card);\n        }\n        function renderConfigInfo() {\n            const container = document.getElementById('configInfo');\n            const config = configData.config;\n            let configItems = [{ label: 'HOST', value: config.HOST }, { label: 'UUID', value: config.KEY.UUID }, { label: 'Skip TLS Verify', value: config.SCV === 'true' ? '‚úÖ Enabled' : '‚ùå Disabled' }];\n            container.innerHTML = configItems.map(item => ('<div class="bg-light rounded p-2 border-start border-primary border-3"><div class="small text-muted fw-medium mb-1">' + item.label + '</div><div class="small fw-semibold monospace">' + item.value + '</div></div>')).join('');\n        }\n        function updatePageTitles() {\n            const subName = configData.sub.SUBNAME;\n            if (subName) {\n                document.getElementById('pageTitle').textContent = subName + ' Configuration';\n                document.getElementById('pageHeader').textContent = 'üîß ' + subName + ' Service Configuration';\n            }\n        }\n        function copyText(text) {\n            navigator.clipboard.writeText(text).then(() => { showToast('‚úÖ Copied to clipboard'); }).catch(err => { console.error('Copy failed:', err); showToast('‚ùå Copy failed'); });\n        }\n        function showToast(message, duration = 3000) {\n            const toast = document.createElement('div');\n            toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);';\n            toast.textContent = message;\n            document.body.appendChild(toast);\n            setTimeout(() => { toast.remove(); }, duration);\n        }\n        function openAdvancedSettings() {\n            loadAdvancedSettings();\n            new bootstrap.Modal(document.getElementById('advancedModal')).show();\n        }\n        function loadAdvancedSettings() {\n            const settings = getAdvancedSettings();\n            document.getElementById('subEnabled').checked = settings.subEnabled;\n            document.getElementById('subInput').value = settings.subValue;\n            document.getElementById('subInput').disabled = !settings.subEnabled;\n            document.getElementById('routeripEnabled').checked = settings.routeripEnabled;\n            document.getElementById('routeripInput').value = settings.routeripValue;\n            document.getElementById('routeripInput').disabled = !settings.routeripEnabled;\n            document.getElementById('relayEnabled').checked = settings.relayEnabled;\n            document.getElementById('relayInput').value = settings.relayValue;\n            document.getElementById('relayInput').disabled = !settings.relayEnabled;\n            document.getElementById('relayGlobalEnabled').checked = settings.relayGlobalEnabled;\n            document.getElementById('relayGlobalEnabled').disabled = !settings.relayEnabled;\n            document.getElementById('fetchEnabled').checked = settings.fetchEnabled;\n            document.getElementById('fetchInput').value = settings.fetchValue;\n            document.getElementById('fetchInput').disabled = !settings.fetchEnabled;\n            document.getElementById('fetchGlobalEnabled').checked = settings.fetchGlobalEnabled;\n            document.getElementById('fetchGlobalEnabled').disabled = !settings.fetchEnabled;\n        }\n        function getAdvancedSettings() {\n            const settings = localStorage.getItem('advancedSubscriptionSettings');\n            if (settings) return JSON.parse(settings);\n            return { subEnabled: false, subValue: '', routeripEnabled: false, routeripValue: '', relayEnabled: false, relayValue: '', relayGlobalEnabled: false, fetchEnabled: false, fetchValue: '', fetchGlobalEnabled: false };\n        }\n        function formatRelayInput(input) {\n            if (!input) return input;\n            return input.trim().replace(/^relay5?:\\/\\//, '').replace(/\\/$/, '').replace(/#.*$/, '');\n        }\n        function formatFetchInput(input) {\n            if (!input) return input;\n            return input.trim().replace(/^fetch:\\/\\//, '').replace(/\\/$/, '').replace(/#.*$/, '');\n        }\n        function saveAdvancedSettings() {\n            const relayValue = formatRelayInput(document.getElementById('relayInput').value);\n            const fetchValue = formatFetchInput(document.getElementById('fetchInput').value);\n            document.getElementById('relayInput').value = relayValue;\n            document.getElementById('fetchInput').value = fetchValue;\n            const settings = {\n                subEnabled: document.getElementById('subEnabled').checked,\n                subValue: document.getElementById('subInput').value,\n                routeripEnabled: document.getElementById('routeripEnabled').checked,\n                routeripValue: document.getElementById('routeripInput').value,\n                relayEnabled: document.getElementById('relayEnabled').checked,\n                relayValue: relayValue,\n                relayGlobalEnabled: document.getElementById('relayGlobalEnabled').checked,\n                fetchEnabled: document.getElementById('fetchEnabled').checked,\n                fetchValue: fetchValue,\n                fetchGlobalEnabled: document.getElementById('fetchGlobalEnabled').checked\n            };\n            localStorage.setItem('advancedSubscriptionSettings', JSON.stringify(settings));\n            bootstrap.Modal.getInstance(document.getElementById('advancedModal')).hide();\n            renderSubscriptionLinks();\n            showToast('üéâ Settings saved! Please copy the updated subscription link above for custom settings to take effect.', 5000);\n        }\n        function updateSettings() {\n            const enabled = document.getElementById('subEnabled').checked;\n            document.getElementById('subInput').disabled = !enabled;\n        }\n        function updateRouterSettings(type) {\n            const enabled = document.getElementById(type + 'Enabled').checked;\n            if (enabled) {\n                const routerTypes = ['routerip', 'relay', 'fetch'];\n                routerTypes.forEach(routerType => {\n                    if (routerType !== type) {\n                        document.getElementById(routerType + 'Enabled').checked = false;\n                        document.getElementById(routerType + 'Input').disabled = true;\n                        if (routerType === 'relay' || routerType === 'fetch') {\n                            const globalCheckbox = document.getElementById(routerType + 'GlobalEnabled');\n                            if (globalCheckbox) { globalCheckbox.checked = false; globalCheckbox.disabled = true; }\n                        }\n                    }\n                });\n            }\n            document.getElementById(type + 'Input').disabled = !enabled;\n            if (type === 'relay' || type === 'fetch') {\n                const globalCheckbox = document.getElementById(type + 'GlobalEnabled');\n                if (globalCheckbox) {\n                    globalCheckbox.disabled = !enabled;\n                    if (!enabled) globalCheckbox.checked = false;\n                }\n            }\n        }\n        document.getElementById('subEnabled').addEventListener('change', updateSettings);\n        document.getElementById('routeripEnabled').addEventListener('change', () => updateRouterSettings('routerip'));\n        document.getElementById('relayEnabled').addEventListener('change', () => updateRouterSettings('relay'));\n        document.getElementById('fetchEnabled').addEventListener('change', () => updateRouterSettings('fetch'));\n    <\/script>\n</body>\n</html>`}

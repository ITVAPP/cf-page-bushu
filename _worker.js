import{connect}from"cloudflare:sockets";const EXPIRE_TIMESTAMP=4102329600,DEFAULT_DLS=8,DEFAULT_REMARK_INDEX=1,DEFAULT_FILENAME=atob("WmlwVg=="),DEFAULT_PATH="/api/data",HTTP_PORTS=["8080","8880","2052","2082","2086","2095"],HTTPS_PORTS=["2053","2083","2087","2096","8443"],DEFAULT_GOS5S=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],USER_AGENTS=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"],FAKE_API_PATHS={primary:"/api/data",alternatives:["/api/v1/stream","/api/v1/analytics","/api/v1/metrics","/api/v2/events","/ws/realtime","/stream/live"]},NORMAL_API_ENDPOINTS=["/api/v1/user","/api/v1/posts","/api/v1/health","/api/v1/status","/api/version"],UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,IPV4_REGEX=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,SOCKS5_PATH_REGEX=/\/socks5=/i,SOCKS_PROTOCOL_REGEX=/\/socks:\/\//i,SOCKS5_PROTOCOL_REGEX=/\/socks5:\/\//i,HTTP_PROTOCOL_REGEX=/\/http:\/\//i,DAILIIP_PATH_REGEX=/\/dailiip=/i,DAILIIP_DOT_REGEX=/\/dailiip\./i,PYIP_PATH_REGEX=/\/pyip=/i,BASE64_REGEX=/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i,IPV6_BRACKET_REGEX=/^\[.*\]$/;let inst_BotToken,inst_ChatID,inst_dailihostsURL,inst_userID="",inst_dailiIPs=[],inst_DNS64Server="",inst_socks5s=[],inst_go2S5s=[...DEFAULT_GOS5S],inst_addresses=[],inst_addressesapi=[],inst_addressesnotls=[],inst_addressesnotlsapi=[],inst_addressescsv=[],inst_DLS=8,inst_remarkIndex=1,inst_FileName=DEFAULT_FILENAME,inst_dailihosts=[],inst_httpPorts=[...HTTP_PORTS],inst_httpsPorts=[...HTTPS_PORTS],inst_link=[],inst_banKeywords=[],inst_banKeywordsRegex=null,inst_SCV="true",inst_allowInsecure="&allowInsecure=1",inst_subEmoji="true",inst_DailiUA="",inst_dns64Cache=new Map,inst_rateLimitMap=new Map;const DNS64_CACHE_TTL=36e5,RATE_LIMIT_WINDOW=6e4;let inst_maxRequestsPerMinute=80,isInstanceInitialized=!1;async function initializeInstance(e){if(!isInstanceInitialized){if(inst_userID=e.UUID||e.uuid||e.PASSWORD||e.pswd||"",(e.dailiIP||e.dailiip)&&(inst_dailiIPs=await zhengli(e.dailiIP||e.dailiip)),inst_DNS64Server=e.DNS64||e.NAT64||"",(e.HTTP||e.SOCKS5)&&(inst_socks5s=await zhengli(e.HTTP||e.SOCKS5)),e.GO2SS5&&(inst_go2S5s=await zhengli(e.GO2SS5)),e.CFPORTS&&(inst_httpsPorts=await zhengli(e.CFPORTS)),e.BAN_KEYWORDS&&""!==e.BAN_KEYWORDS.trim()&&(inst_banKeywords=await zhengli(e.BAN_KEYWORDS),inst_banKeywords.length>0)){const e=inst_banKeywords.filter((e=>e&&e.trim()));if(e.length>0){const t=e.map((e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))).join("|");inst_banKeywordsRegex=new RegExp(t,"i")}}if(e.ADD&&(inst_addresses=await zhengli(e.ADD)),e.ADDAPI&&(inst_addressesapi=await zhengli(e.ADDAPI)),e.ADDNOTLS&&(inst_addressesnotls=await zhengli(e.ADDNOTLS)),e.ADDNOTLSAPI&&(addressesnotlsapi=await zhengli(e.ADDNOTLSAPI)),e.ADDCSV&&(inst_addressescsv=await zhengli(e.ADDCSV)),inst_DLS=Number(e.DLS)||inst_DLS,inst_remarkIndex=Number(e.CSVREMARK)||inst_remarkIndex,inst_BotToken=e.TGTOKEN||inst_BotToken,inst_ChatID=e.TGID||inst_ChatID,inst_FileName=e.SUBNAME||inst_FileName,inst_subEmoji=e.SUBEMOJI||e.EMOJI||inst_subEmoji,"0"==inst_subEmoji&&(inst_subEmoji="false"),inst_DailiUA=e.DAILI_UA||"",e.LINK&&(inst_link=await zhengli(e.LINK)),inst_SCV=e.SCV||inst_SCV,inst_SCV&&"0"!=inst_SCV&&"false"!=inst_SCV?inst_SCV="true":inst_allowInsecure="",e.RATE_LIMIT){const t=Number(e.RATE_LIMIT);t>0&&(inst_maxRequestsPerMinute=t)}isInstanceInitialized=!0}}function getRandomUserAgent(){return USER_AGENTS[Math.floor(Math.random()*USER_AGENTS.length)]}function addNormalHeaders(e,t=!0){return e["X-Content-Type-Options"]="nosniff",e["X-Frame-Options"]="SAMEORIGIN",e["Referrer-Policy"]="strict-origin-when-cross-origin",t&&(e["Cache-Control"]="public, max-age=3600",e.Vary="Accept-Encoding"),e}function getGeoInfo(e){const t=e.headers.get("cf-connecting-ipv6")||e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"0.0.0.0",n=e.headers.get("cf-ray"),a=n?n.split("-")[1]:null;return{ip:t,country:e.cf?.country||e.headers.get("cf-ipcountry")||"N/A",countryRegion:e.cf?.region||e.headers.get("cf-region")||"N/A",city:e.cf?.city||e.headers.get("cf-ipcity")||"N/A",region:e.cf?.colo||a||"N/A",latitude:null!=e.cf?.latitude?String(e.cf.latitude):e.headers.get("cf-iplatitude")||"N/A",longitude:null!=e.cf?.longitude?String(e.cf.longitude):e.headers.get("cf-iplongitude")||"N/A",asOrganization:e.cf?.asOrganization||e.headers.get("x-asn")||"N/A",timezone:e.cf?.timezone||"N/A",asn:e.cf?.asn||"N/A"}}function generateFakeAPIResponse(e,t){const n=(new Date).toISOString(),a=getGeoInfo(t);return{"/api/v1/user":{success:!0,data:{id:Math.random().toString(36).substr(2,9),username:"user_"+Math.floor(1e4*Math.random()),created_at:n,last_login:n},timestamp:n},"/api/v1/posts":{success:!0,data:{posts:Array.from({length:5},((e,t)=>({id:t+1,title:`Post ${t+1}`,created_at:n}))),total:5,page:1},timestamp:n},"/api/v1/health":{status:"healthy",uptime:Math.floor(86400*Math.random()),version:"1.2.3",timestamp:n},"/api/v1/status":{operational:!0,services:{api:"online",database:"online",cache:"online"},region:a.region,timestamp:n},"/api/version":{version:"1.2.3",build:"production",commit:Math.random().toString(36).substr(2,7),timestamp:n}}[e]||{error:"Not Found",message:"The requested endpoint does not exist",timestamp:n}}function isDailiPath(e,t){return e===t||e===FAKE_API_PATHS.primary||!!FAKE_API_PATHS.alternatives.includes(e)}function generateFakeWebSocketRejection(e="invalid_token"){return new Response(JSON.stringify({success:!1,error:e,message:"WebSocket connection requires valid authentication token",timestamp:(new Date).toISOString()}),{status:401,headers:{"Content-Type":"application/json","WWW-Authenticate":'Bearer realm="API"',"X-RateLimit-Limit":"100","X-RateLimit-Remaining":Math.floor(100*Math.random()).toString(),"X-RateLimit-Reset":Date.now()+36e5}})}function generateGeoHTML(e,t=!1){const n=`\n        <tr><th>IP Address</th><td><code>${e.ip}</code></td></tr>\n        <tr><th>Country</th><td>${e.country}</td></tr>\n        <tr><th>Region</th><td>${e.countryRegion}</td></tr>\n        <tr><th>City</th><td>${e.city}</td></tr>\n        <tr><th>Data Center (Colo)</th><td>${e.region}</td></tr>\n        <tr><th>Latitude</th><td>${e.latitude}</td></tr>\n        <tr><th>Longitude</th><td>${e.longitude}</td></tr>\n        <tr><th>ASN</th><td>${e.asn}</td></tr>\n        <tr><th>Organization</th><td>${e.asOrganization}</td></tr>\n        <tr><th>Timezone</th><td>${e.timezone}</td></tr>\n    `;return t?`\n            <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                <title>IP Geolocation API</title>\n                <style>\n        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f7f9; margin: 0; padding: 20px; }\n        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n        h1, h2 { color: #007bff; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n        th { background-color: #f8f9fa; }\n        code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n        .footer { text-align: center; margin-top: 20px; font-size: 0.9em; color: #777; }\n        .api-info { margin-top: 30px; }\n        .api-info pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; }\n    </style>\n            </head>\n            <body>\n                <div class="container">\n                    <h1>IP Geolocation API</h1>\n                    <p>Your current connection details:</p>\n                    <table>\n                        ${n}\n                    </table>\n                    <div class="api-info">\n                        <h2>API Usage</h2>\n                        <p>To get this information in JSON format, make a request to <code>/geo</code>.</p>\n                        <p>Example response:</p>\n                        <pre>${JSON.stringify(e,null,2)}</pre>\n                    </div>\n                    <div class="footer">\n                        <p>Powered by Cloudflare Workers.</p>\n                    </div>\n                </div>\n            </body>\n            </html>\n        `:`\n            <table style="width: 100%; margin: 0 auto; text-align: left; border: 1px solid #ddd;">\n                ${n}\n            </table>\n        `}function checkRateLimit(e){const t=Date.now(),n=inst_rateLimitMap.get(e);if(!n||t-n.timestamp>6e4){if(inst_rateLimitMap.set(e,{count:1,timestamp:t}),inst_rateLimitMap.size>1e4)for(const[e,n]of inst_rateLimitMap.entries())t-n.timestamp>6e4&&inst_rateLimitMap.delete(e);return!0}return n.count++,n.count<=inst_maxRequestsPerMinute}function containsBannedKeyword(e){if(!inst_banKeywords||0===inst_banKeywords.length)return!1;if(inst_banKeywordsRegex)return inst_banKeywordsRegex.test(e);const t=e.toLowerCase();for(const e of inst_banKeywords)if(e&&e.trim()&&t.includes(e.toLowerCase()))return!0;return!1}export default{async fetch(e,t,n){isInstanceInitialized||await initializeInstance(t);try{if(!checkRateLimit(e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||"unknown"))return new Response("Too Many Requests",{status:429,headers:{"Content-Type":"text/plain; charset=UTF-8","Retry-After":"60"}});const n=e.headers.get("User-Agent")||"null",a=n.toLowerCase();if(!inst_userID||!isValidUUID(inst_userID))return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});let s=inst_dailiIPs.length>0?inst_dailiIPs[Math.floor(Math.random()*inst_dailiIPs.length)]:"",i=inst_socks5s.length>0?inst_socks5s[Math.floor(Math.random()*inst_socks5s.length)]:"",o=!!t.HTTP||i.toLowerCase().includes("http://");i&&(i=i.split("//")[1]||i);let r={},l=!1,c="false";if(i)try{r=s5AddressParser(i),c=t.RdailiIP||"false",l=!0}catch(e){c=t.RdailiIP||!s?"true":"false",l=!1}else c=t.RdailiIP||!s?"true":"false";const d=e.headers.get("Upgrade"),p=new URL(e.url);if(d&&"websocket"===d){if(inst_DailiUA&&""!==inst_DailiUA.trim()){const t=(e.headers.get("App-Client")||"").toLowerCase(),n=inst_DailiUA.toLowerCase();if(!a.includes(n)&&!t.includes(n))return new Response("Forbidden: Access Denied via Restriction",{status:403,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}if(!isDailiPath(p.pathname.toLowerCase(),"/api/data"))return generateFakeWebSocketRejection("invalid_endpoint");let t=p.searchParams.get("socks5")||p.searchParams.get("http")||i,n=!!p.searchParams.get("http")||o,c=p.searchParams.has("globaldaili")?["all in"]:inst_go2S5s,d=s,u=l,h=r;if(SOCKS5_PATH_REGEX.test(p.pathname))t=p.pathname.split("5=")[1];else if(SOCKS_PROTOCOL_REGEX.test(p.pathname)||SOCKS5_PROTOCOL_REGEX.test(p.pathname)||HTTP_PROTOCOL_REGEX.test(p.pathname)){if(n=p.pathname.includes("http://"),t=p.pathname.split("://")[1].split("#")[0],t.includes("@")){const e=t.lastIndexOf("@");let n=t.substring(0,e).replaceAll("%3D","=");BASE64_REGEX.test(n)&&!n.includes(":")&&(n=atob(n)),t=`${n}@${t.substring(e+1)}`}c=["all in"]}if(t)try{h=s5AddressParser(t),u=!0}catch(e){u=!1}else u=!1;return p.searchParams.has("dailiip")?(d=p.searchParams.get("dailiip"),u=!1):DAILIIP_PATH_REGEX.test(p.pathname)?(d=p.pathname.toLowerCase().split("/dailiip=")[1],u=!1):DAILIIP_DOT_REGEX.test(p.pathname)?(d=`dailiip.${p.pathname.toLowerCase().split("/dailiip.")[1]}`,u=!1):PYIP_PATH_REGEX.test(p.pathname)&&(d=p.pathname.toLowerCase().split("/pyip=")[1],u=!1),await zipvOverWSHandler(e,{userID:inst_userID,go2S5s:c,enableSocks:u,enableHttp:n,parsedS5Address:h,dailiIP:d})}{let s="/api/data",i="false";p.searchParams.has("notls")&&(i="true");const r=["dailiip","socks5","socks","http"];for(const e of r)if(p.searchParams.has(e)){const t=p.searchParams.get(e),n=p.searchParams.has("globaldaili"),a="socks"===e?"socks5":e;s="dailiip"===a?`/${a}=${t}`:n?`/?${a}=${t}&globaldaili`:`/?${a}=${t}`,c="false";break}const l=p.pathname.toLowerCase();if(NORMAL_API_ENDPOINTS.includes(l)){const t=generateFakeAPIResponse(l,e),n=t.error?404:200;return new Response(JSON.stringify(t,null,2),{status:n,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.2.3","X-Request-ID":Math.random().toString(36).substr(2,16)})})}if("/"==l){if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await dailiURL(t.URL,p);const n=generateGeoHTML(getGeoInfo(e),!0);return new Response(n,{status:200,headers:addNormalHeaders({"Content-Type":"text/html; charset=UTF-8"})})}if("/geo"===l){const t=getGeoInfo(e);return new Response(JSON.stringify(t,null,2),{status:200,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*"}})}if(l==`/${inst_userID}/config.json`){let a=p.searchParams.has("sub")&&""!==p.searchParams.get("sub")?p.searchParams.get("sub").toLowerCase():t.SUB||"";return await config_Json(inst_userID,e.headers.get("Host"),a,n,c,p,t,{dailiIPs:inst_dailiIPs,socks5s:inst_socks5s,go2S5s:inst_go2S5s,enableHttp:o})}if("/getusage"!==l&&l!==`/${inst_userID}/getusage`){if(p.pathname==`/${inst_userID}`){let s=p.searchParams.has("sub")&&""!==p.searchParams.get("sub")?p.searchParams.get("sub").toLowerCase():t.SUB||"";const i=await peizhi(inst_userID,e.headers.get("Host"),s,n,c,p,t,e),o=Date.now(),r=new Date(o);r.setHours(0,0,0,0);const l=Math.floor((o-r.getTime())/864e5*24*1099511627776/2);let d=l,u=l,h=26388279066624;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{const e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL);h=t.CF_ALL?Number(t.CF_ALL):1e5;d=h-e,u=e}catch(e){}return a&&a.includes("mozilla")?new Response(i,{status:200,headers:addNormalHeaders({"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${u}; total=${h}; expire=4102329600`,"Cache-Control":"no-store"},!1)}):new Response(i,{status:200,headers:addNormalHeaders({"Content-Disposition":`attachment; filename=${inst_FileName}; filename*=utf-8''${encodeURIComponent(inst_FileName)}`,"Profile-Update-Interval":"6","Profile-web-page-url":e.url.includes("?")?e.url.split("?")[0]:e.url,"Subscription-Userinfo":`upload=${d}; download=${u}; total=${h}; expire=4102329600`},!1)})}if(isDailiPath(l,s)){const e={success:!0,message:"Data endpoint ready",version:"1.0.0",timestamp:(new Date).toISOString(),endpoints:{websocket:"wss://example.com/api/data",status:"/api/v1/status",health:"/api/v1/health"}};return new Response(JSON.stringify(e,null,2),{status:200,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.0.0","X-Content-Type-Options":"nosniff"})})}{if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await dailiURL(t.URL,p);const n=`\n                        <!DOCTYPE html>\n                        <html lang="en">\n                        <head>\n                            <meta charset="UTF-8">\n                            <title>403 Forbidden</title>\n                            <style>\n                                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }\n                                .container { max-width: 800px; margin: 2em auto; padding: 1em; }\n                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n                                th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n                                th { background-color: #f8f9fa; }\n                                code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n                            </style>\n                        </head>\n                        <body>\n                            <div class="container">\n                                <h1>403 Forbidden</h1>\n                                <p>Access Denied: You do not have permission to access this resource.</p>\n                                <hr>\n                                ${generateGeoHTML(getGeoInfo(e),!1).replace("<table",'<table style="width:100%;"')}\n                            </div>\n                        </body>\n                        </html>\n                    `;return new Response(n,{status:403,headers:{"Content-Type":"text/html; charset=UTF-8"}})}}try{let e=0,n=1e5;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL),n=t.CF_ALL?Number(t.CF_ALL):1e5}catch(t){const a=Date.now(),s=new Date(a);s.setHours(0,0,0,0);const i=(a-s.getTime())/864e5,o=Math.floor(n*i*.5);e=Math.max(0,n-o)}else{const t=Date.now(),a=new Date(t);a.setHours(0,0,0,0);const s=(t-a.getTime())/864e5,i=Math.floor(n*s*.5);e=Math.max(0,n-i)}const a=n-e;return new Response(JSON.stringify({success:!0,data:{total:n,used:a,remaining:e,percentage:(a/n*100).toFixed(2)+"%"},timestamp:(new Date).toISOString()},null,2),{status:200,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}catch(e){return new Response(JSON.stringify({success:!1,error:e.message||"Unknown error",timestamp:(new Date).toISOString()},null,2),{status:500,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}}}catch(e){return new Response(`Internal Server Error: ${e.message}`,{status:500,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}}};async function zipvOverWSHandler(e,t){const n=new WebSocketPair,[a,s]=Object.values(n);s.accept();let i="",o="";const r=()=>{},l=e.headers.get("sec-websocket-protocol")||"",c=makeReadableWebSocketStream(s,l,r);let d={value:null},p=null,u=!1;return c.pipeTo(new WritableStream({async write(e,n){if(u&&p)return p(e);if(d.value){const t=d.value.writable.getWriter();return await t.write(e),void t.releaseLock()}const{hasError:a,message:l,addressType:c,portRemote:h=443,addressRemote:m="",rawDataIndex:f,zipvVersion:g=new Uint8Array([0,0]),isUDP:b}=processzipvHeader(e,t.userID);if(i=m,o=`${h}--${Math.random()} ${b?"udp ":"tcp "} `,a)throw new Error(l);if(b){if(53!==h)throw new Error("UDP daili仅对 DNS（53 端口）启用");u=!0}const y=new Uint8Array([g[0],0]),w=e.slice(f);if(u){const{write:e}=await handleUDPOutBound(s,y,r);return p=e,void p(w)}if(containsBannedKeyword(m))throw new Error(`黑名单拦截连接 ${m}:${h}`);handleTCPOutBound(d,c,m,h,w,s,y,r,t)},close(){},abort(e){}})).catch((()=>{})),new Response(null,{status:101,webSocket:a})}async function handleTCPOutBound(e,t,n,a,s,i,o,r,l){const{go2S5s:c,enableSocks:d,enableHttp:p,parsedS5Address:u,dailiIP:h}=l;async function m(n,a,i=!1,o=!1,l){const c=i?o?await httpConnect(n,a,r,l):await socks5Connect(t,n,a,r,l):connect({hostname:n,port:a});if(!i)try{await Promise.race([c.opened,new Promise(((e,t)=>setTimeout((()=>t(new Error("连接超时"))),3e3)))])}catch(e){try{c.close()}catch(e){}throw new Error(`直连失败: ${e.message}`)}e.value=c;const d=c.writable.getWriter();return await d.write(s),d.releaseLock(),c}async function f(){if(!b){const e=`[${await resolveToIPv6(n)}]`;g=await m(e,443,!1,!1,null)}g.closed.catch((()=>{})).finally((()=>{safeCloseWebSocket(i)})),remoteSocketToWS(g,i,o,null,r)}let g,b=!1;c.length>0&&d&&(b=await async function(e){return!(!c.includes(atob("YWxsIGlu"))&&!c.includes(atob("Kg==")))||c.some((t=>{let n=t.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(e)}))}(n));try{g=await m(n,a,b,p,u)}catch(e){if(1!==t||b||p)throw e;try{let e=await resolveToIPv6(n);e.startsWith("[")&&e.endsWith("]")&&(e=e.slice(1,-1)),g=await m(e,a,!1,!1,null)}catch(t){throw e}}remoteSocketToWS(g,i,o,(async function(){if(d)g=await m(n,a,!0,p,u);else{let e=h,t=a;e&&""!=e?e.includes("]:")?(t=e.split("]:")[1]||a,e=e.split("]:")[0]+"]"||e):2===e.split(":").length&&(t=e.split(":")[1]||a,e=e.split(":")[0]||e):e=atob("UFJPWFlJUC50cDEuMDkwMjI3Lnh5eg=="),e.includes(".tp")&&(t=e.split(".tp")[1].split(".")[0]||a),g=await m(e.toLowerCase()||n,t,!1,!1,null)}remoteSocketToWS(g,i,o,f,r)}),r)}function makeReadableWebSocketStream(e,t){let n=!1;return new ReadableStream({start(a){e.addEventListener("message",(e=>{if(n)return;const t=e.data;a.enqueue(t)})),e.addEventListener("close",(()=>{safeCloseWebSocket(e),n||a.close()})),e.addEventListener("error",(e=>{a.error(e)}));const{earlyData:s,error:i}=base64ToArrayBuffer(t);i?a.error(i):s&&a.enqueue(s)},pull(e){},cancel(t){n||(n=!0,safeCloseWebSocket(e))}})}function processzipvHeader(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};const n=new Uint8Array(e.slice(0,1));let a=!1,s=!1;if(a=stringify(new Uint8Array(e.slice(1,17)))===t,!a)return{hasError:!0,message:`invalid user ${new Uint8Array(e.slice(1,17))}`};const i=new Uint8Array(e.slice(17,18))[0],o=new Uint8Array(e.slice(18+i,18+i+1))[0];if(1===o);else{if(2!==o)return{hasError:!0,message:`command ${o} is not support, command 01-tcp,02-udp,03-mux`};s=!0}const r=18+i+1,l=e.slice(r,r+2),c=new DataView(l).getUint16(0);let d=r+2;const p=new Uint8Array(e.slice(d,d+1))[0];let u=0,h=d+1,m="";switch(p){case 1:u=4,m=new Uint8Array(e.slice(h,h+u)).join(".");break;case 2:u=new Uint8Array(e.slice(h,h+1))[0],h+=1,m=(new TextDecoder).decode(e.slice(h,h+u));break;case 3:u=16;const t=new DataView(e.slice(h,h+u)),n=[];for(let e=0;e<8;e++)n.push(t.getUint16(2*e).toString(16));m=n.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return m?{hasError:!1,addressRemote:m,addressType:p,portRemote:c,rawDataIndex:h+u,zipvVersion:n,isUDP:s}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function remoteSocketToWS(e,t,n,a){let s=n,i=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,n){i=!0,t.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket.readyState is not open, maybe close"),s?(t.send(await new Blob([s,e]).arrayBuffer()),s=null):t.send(e)},close(){},abort(e){}})).catch((()=>{safeCloseWebSocket(t)})),!1===i&&a&&a()}function base64ToArrayBuffer(e){if(!e)return{earlyData:void 0,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{earlyData:void 0,error:e}}}function isValidUUID(e){return UUID_REGEX.test(e)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){}}const byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase()}function stringify(e,t=0){const n=unsafeStringify(e,t);if(!isValidUUID(n))throw TypeError(`生成的 UUID 不符合规范 ${n}`);return n}async function handleUDPOutBound(e,t){let n=!1;const a=new TransformStream({start(e){},transform(e,t){for(let n=0;n<e.byteLength;){const a=e.slice(n,n+2),s=new DataView(a).getUint16(0),i=new Uint8Array(e.slice(n+2,n+2+s));n=n+2+s,t.enqueue(i)}},flush(e){}});a.readable.pipeTo(new WritableStream({async write(a){const s=await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:a}),i=await s.arrayBuffer(),o=i.byteLength,r=new Uint8Array([o>>8&255,255&o]);e.readyState===WS_READY_STATE_OPEN&&(n?e.send(await new Blob([r,i]).arrayBuffer()):(e.send(await new Blob([t,r,i]).arrayBuffer()),n=!0))}})).catch((()=>{}));const s=a.writable.getWriter();return{write(e){s.write(e)}}}async function handleDNSQuery(e,t,n){try{let a=n;const s=connect({hostname:"8.8.4.4",port:53}),i=s.writable.getWriter();await i.write(e),i.releaseLock(),await s.readable.pipeTo(new WritableStream({async write(e){t.readyState===WS_READY_STATE_OPEN&&(a?(t.send(await new Blob([a,e]).arrayBuffer()),a=null):t.send(e))},close(){},abort(e){}}))}catch(e){}}async function socks5Connect(e,t,n,a,s){const{username:i,password:o,hostname:r,port:l}=s,c=connect({hostname:r,port:l}),d=c.writable.getWriter(),p=c.readable.getReader(),u=new TextEncoder;try{const s=new Uint8Array([5,2,0,2]);await d.write(s);let r,l=(await p.read()).value;if(5!==l[0])throw new Error("SOCKS版本不匹配");if(255===l[1])throw new Error("服务器不接受任何认证方法");if(2===l[1]){if(a("SOCKS5 服务器需要认证"),!i||!o)throw new Error("请提供用户名和密码");const e=new Uint8Array([1,i.length,...u.encode(i),o.length,...u.encode(o)]);if(await d.write(e),l=(await p.read()).value,1!==l[0]||0!==l[1])throw new Error("SOCKS5 服务器认证失败")}switch(e){case 1:r=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:r=new Uint8Array([3,t.length,...u.encode(t)]);break;case 3:r=new Uint8Array([4,...t.split(":").flatMap((e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)]))]);break;default:throw new Error(`不支持的地址类型: ${e}`)}const h=new Uint8Array([5,1,0,...r,n>>8,255&n]);if(await d.write(h),l=(await p.read()).value,0!==l[1])throw new Error(`SOCKS5 连接建立失败，错误码: ${l[1]}`);return a("SOCKS5 连接已建立"),d.releaseLock(),p.releaseLock(),c}catch(e){try{d.releaseLock()}catch(e){}try{p.releaseLock()}catch(e){}try{c.close()}catch(e){}throw e}}async function httpConnect(e,t,n,a){const{username:s,password:i,hostname:o,port:r}=a,l=await connect({hostname:o,port:r});let c=`CONNECT ${e}:${t} HTTP/1.1\r\n`;if(c+=`Host: ${e}:${t}\r\n`,s&&i){c+=`daili-Authorization: Basic ${btoa(`${s}:${i}`)}\r\n`}c+="User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\r\n",c+="daili-Connection: Keep-Alive\r\n",c+="Connection: Keep-Alive\r\n",c+="\r\n";const d=l.writable.getWriter(),p=l.readable.getReader();try{await d.write((new TextEncoder).encode(c))}catch(e){try{d.releaseLock()}catch(e){}try{p.releaseLock()}catch(e){}try{l.close()}catch(e){}throw new Error(`发送HTTP CONNECT请求失败: ${e.message}`)}let u=new Uint8Array(0),h=-1,m=0;try{for(;-1===h&&m<8192;){const{value:e,done:t}=await p.read();if(t)throw new Error("HTTPdaili连接中断");const n=new Uint8Array(u.length+e.length);n.set(u),n.set(e,u.length),u=n,m=u.length;const a=u.findIndex(((e,t)=>t<u.length-3&&13===u[t]&&10===u[t+1]&&13===u[t+2]&&10===u[t+3]));-1!==a&&(h=a+4)}if(-1===h)throw new Error("HTTPdaili响应格式无效：未找到header结束标记");const e=(new TextDecoder).decode(u.slice(0,h)),t=e.split("\r\n")[0].match(/HTTP\/\d\.\d\s+(\d+)/);if(!t)throw new Error("HTTPdaili响应格式无效：无法解析状态行");const n=parseInt(t[1]);if(n<200||n>=300)throw new Error(`HTTPdaili连接失败: HTTP ${n} - ${e.split("\r\n")[0]}`);if(h<u.length){const e=u.slice(h),t=new ReadableStream({start(t){t.enqueue(e)}}),{readable:n,writable:a}=new TransformStream;t.pipeTo(a).catch((()=>{})),l.readable=n}return p.releaseLock(),l}catch(e){try{d.releaseLock()}catch(e){}try{p.releaseLock()}catch(e){}try{l.close()}catch(e){}throw new Error(`处理HTTPdaili响应失败: ${e.message}`)}}function s5AddressParser(e){if(!e||"string"!=typeof e)throw new Error("无效的 SOCKS 地址格式：地址不能为空");const t=e.lastIndexOf("@");let n,a,s,i,[o,r]=-1===t?[e,void 0]:[e.substring(t+1),e.substring(0,t)];if(r){const e=r.split(":");if(2!==e.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[n,a]=e}const l=o.split(":");if(l.length>2&&o.includes("]:")?(i=Number(o.split("]:")[1].replace(/[^\d]/g,"")),s=o.split("]:")[0]+"]"):2===l.length?(i=Number(l.pop().replace(/[^\d]/g,"")),s=l.join(":")):(i=80,s=o),isNaN(i)||i<1||i>65535)throw new Error("无效的 SOCKS 地址格式：端口号必须是 1-65535 之间的数字");if(s.includes(":")&&!IPV6_BRACKET_REGEX.test(s))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:n,password:a,hostname:s,port:i}}async function dailiURL(e,t){const n=await zhengli(e),a=n[Math.floor(Math.random()*n.length)];let s=new URL(a),i=s.protocol.slice(0,-1)||"https",o=s.hostname,r=s.pathname,l=s.search;"/"==r.charAt(r.length-1)&&(r=r.slice(0,-1)),r+=t.pathname;let c=`${i}://${o}${r}${l}`,d=await fetch(c),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",c),p}let subParams=["sub","base64","b64"];async function zhengli(e){var t=e.replace(/[\t"'\r\n]+/g,",").replace(/,+/g,",");","==t.charAt(0)&&(t=t.slice(1)),","==t.charAt(t.length-1)&&(t=t.slice(0,t.length-1));return t.split(",")}function isValidIPv4(e){return IPV4_REGEX.test(e)}async function resolveToIPv6(e){const t=e.toLowerCase(),n=inst_dns64Cache.get(t);if(n&&Date.now()-n.timestamp<DNS64_CACHE_TTL)return n.ipv6;const a=atob("UHJveHlJUC5jbUxpdVNzc1MuTmV0");if(!inst_DNS64Server)try{const e=await fetch(atob("aHR0cHM6Ly8xLjEuMS4xL2Rucy1xdWVyeT9uYW1lPW5hdDY0LmNtbGl1c3Nzcy5uZXQmdHlwZT1UWFQ="),{headers:{Accept:"application/dns-json"}});if(!e.ok)return a;const t=((await e.json()).Answer||[]).filter((e=>16===e.type)).map((e=>e.data));if(0===t.length)return a;let n=t[0];n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1));const s=n.replace(/\\010/g,"\n").split("\n").filter((e=>e.trim()));if(0===s.length)return a;inst_DNS64Server=s[Math.floor(Math.random()*s.length)]}catch(e){return a}function s(e){return e.includes(":")&&/^[0-9a-fA-F:]+$/.test(e)}try{if(s(e))return e;const n=function(e){const t=e.split(".");return 4===t.length&&t.every((e=>{const t=parseInt(e,10);return t>=0&&t<=255&&e===t.toString()}))}(e)?e:await async function(e){const t=`https://1.1.1.1/dns-query?name=${e}&type=A`,n=await fetch(t,{headers:{Accept:"application/dns-json"}});if(!n.ok)throw new Error("DNS查询失败");const a=((await n.json()).Answer||[]).filter((e=>1===e.type)).map((e=>e.data));if(0===a.length)throw new Error("未找到IPv4地址");return a[Math.floor(Math.random()*a.length)]}(e),i=inst_DNS64Server.endsWith("/96")?function(e){const t=e.split(".");if(4!==t.length)throw new Error("无效的IPv4地址");const n=t.map((e=>{const t=parseInt(e,10);if(t<0||t>255)throw new Error("无效的IPv4地址段");return t.toString(16).padStart(2,"0")}));return inst_DNS64Server.split("/96")[0]+n[0]+n[1]+":"+n[2]+n[3]}(n):await async function(e){const t=connect({hostname:s(inst_DNS64Server)?`[${inst_DNS64Server}]`:inst_DNS64Server,port:53}),n=t.writable.getWriter(),a=t.readable.getReader();try{const t=function(e){const t=new ArrayBuffer(512),n=new DataView(t);let a=0;n.setUint16(a,Math.floor(65536*Math.random())),a+=2,n.setUint16(a,256),a+=2,n.setUint16(a,1),a+=2,n.setUint16(a,0),a+=6;for(const t of e.split(".")){n.setUint8(a++,t.length);for(let e=0;e<t.length;e++)n.setUint8(a++,t.charCodeAt(e))}return n.setUint8(a++,0),n.setUint16(a,28),a+=2,n.setUint16(a,1),a+=2,new Uint8Array(t,0,a)}(e),s=new Uint8Array(t.length+2);s[0]=t.length>>8,s[1]=255&t.length,s.set(t,2),await n.write(s);const i=await async function(e){const t=[];let n=0,a=null;for(;;){const{value:s,done:i}=await e.read();if(i)break;if(t.push(s),n+=s.length,null===a&&n>=2&&(a=t[0][0]<<8|t[0][1]),null!==a&&n>=a+2)break}const s=new Uint8Array(n);let i=0;for(const e of t)s.set(e,i),i+=e.length;return s.slice(2)}(a),o=function(e){const t=new DataView(e.buffer);let n=12;for(;0!==t.getUint8(n);)n+=t.getUint8(n)+1;n+=5;const a=[],s=t.getUint16(6);for(let e=0;e<s;e++){if(192==(192&t.getUint8(n)))n+=2;else{for(;0!==t.getUint8(n);)n+=t.getUint8(n)+1;n++}const e=t.getUint16(n);n+=2,n+=6;const s=t.getUint16(n);if(n+=2,28===e&&16===s){const e=[];for(let a=0;a<8;a++)e.push(t.getUint16(n+2*a).toString(16));a.push(e.join(":"))}n+=s}return a}(i);return o.length>0?o[0]:"未找到IPv6地址"}finally{await n.close(),await a.cancel()}}(n+atob("LmlwLjA5MDIyNy54eXo="));if(s(i)&&i!==a&&(inst_dns64Cache.set(t,{ipv6:i,timestamp:Date.now()}),inst_dns64Cache.size>1e3)){const e=inst_dns64Cache.keys().next().value;inst_dns64Cache.delete(e)}return s(i)?i:a}catch(e){return a}}async function getUsage(e,t,n,a,s=1e5){try{if(!e){if(!t||!n)throw new Error("缺少必要的认证信息: email和apikey不能为空");e=await async function(e,t){const n=await fetch("https://api.cloudflare.com/client/v4/accounts",{method:"GET",headers:{"Content-Type":"application/json","X-AUTH-EMAIL":e,"X-AUTH-KEY":t}});if(!n.ok){const e=await n.text();throw new Error(`Cloudflare API 请求失败: ${n.status} ${n.statusText} - ${e}`)}const a=await n.json();let s=0,i=!1;if(a?.result&&a.result.length>1){const t=e.toLowerCase();for(let e=0;e<a.result.length;e++)if((a.result[e]?.name?.toLowerCase()||"").startsWith(t)){s=e,i=!0;break}}else a?.result&&1===a.result.length&&(i=!0);const o=a?.result?.[s]?.id;if(!o)throw new Error("找不到有效的账户ID,请检查API权限");return o}(t,n)}const i=new Date,o=i.toISOString();i.setUTCHours(0,0,0,0);const r=i.toISOString();let l={};if(n&&t)l={"Content-Type":"application/json","X-AUTH-EMAIL":t,"X-AUTH-KEY":n};else{if(!a)throw new Error("缺少认证信息: 需要提供(email+apikey)或apitoken");l={"Content-Type":"application/json",Authorization:`Bearer ${a}`}}const c=await fetch("https://api.cloudflare.com/client/v4/graphql",{method:"POST",headers:l,body:JSON.stringify({query:"query getBillingMetrics($accountId: String!, $filter: AccountWorkersInvocationsAdaptiveFilter_InputObject) {\n                    viewer {\n                        accounts(filter: {accountTag: $accountId}) {\n                            pagesFunctionsInvocationsAdaptiveGroups(limit: 1000, filter: $filter) {\n                                sum {\n                                    requests\n                                }\n                            }\n                            workersInvocationsAdaptive(limit: 10000, filter: $filter) {\n                                sum {\n                                    requests\n                                }\n                            }\n                        }\n                    }\n                }",variables:{accountId:e,filter:{datetime_geq:r,datetime_leq:o}}})});if(!c.ok){const e=await c.text();throw new Error(`GraphQL API请求失败: ${c.status} - ${e}`)}const d=await c.json();if(d.errors&&d.errors.length>0){const e=d.errors[0].message||"Unknown GraphQL error";throw new Error(`GraphQL错误: ${e}`)}const p=d?.data?.viewer?.accounts?.[0];if(!p)return 0;const u=(p?.pagesFunctionsInvocationsAdaptiveGroups||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0),h=u+(p?.workersInvocationsAdaptive||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0),m=Number(s)||1e5;return Math.max(0,m-h)}catch(e){throw e}}const hunxiao=atob("ZG14bGMzTT0=");async function config_Json(e,t,n,a,s,i,o,r){const{dailiIPs:l,socks5s:c,go2S5s:d,enableHttp:p}=r,u=c.map((e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e)).filter((e=>""!==e));let h="auto";c.length>0?h=p?"http":"socks5":l.length>0?h="dailiip":"true"==s&&(h="auto");let m=t,f=443,g=["tls",!0];t.includes(".workers.dev")&&(m=e+"."+t+".cf.090227.xyz",f=80,g=["",!1]);const b={timestamp:(new Date).toISOString(),config:{HOST:t,KEY:{UUID:e.toLowerCase()||null},SCV:inst_SCV},dailiip:{RequestdailiIP:s,GO2CF:h,List:{daili_IP:l.filter((e=>""!==e)),SOCKS5:p?[]:u,HTTP:p?u:[]},GO2SS5:d.includes("all in")||d.includes("*")?["all in"]:d},sub:{SUBNAME:inst_FileName,SUB:n&&"local"!=n?n:"local",ADD:inst_addresses,ADDNOTLS:inst_addressesnotls,ADDAPI:inst_addressesapi,ADDNOTLSAPI:inst_addressesnotlsapi,ADDCSV:inst_addressescsv,DLS:inst_DLS,CSVREMARK:inst_remarkIndex},link:{v2:`${atob(hunxiao)}://${e.toLowerCase()}@${m}:${f}?encryp${atob("dGlvbj0=")}none&security=${g[0]}&sni=${m}&fp=randomized&type=ws&host=${t}&path=${encodeURIComponent("/api/data")+inst_allowInsecure}&fragment=${encodeURIComponent("1,40-60,30-50,tlshello")}#${encodeURIComponent(inst_FileName)}`},KV:!!o.KV,UA:a||null};return new Response(JSON.stringify(b,null,2),{headers:{"access-control-allow-origin":"*","Content-Type":"application/json","Cache-Control":"no-cache"}})}async function peizhi(e,t,n,a,s,i,o,r){if(n){const p=n.match(/^(?:https?:\/\/)?([^\/]+)/);p&&(n=p[1]);const u=await zhengli(n);u.length>1&&(n=u[0])}else if(inst_addresses.length+inst_addressesapi.length+inst_addressesnotls.length+inst_addressesnotlsapi.length+inst_addressescsv.length==0){let h=["104.16.0.0/13"];function l(e){const[t,n]=e.split("/"),a=t.split(".").map(Number),s=32-parseInt(n,10),i=Math.pow(2,s)-1,o=Math.floor(Math.random()*i);return a.map(((e,t)=>t<2?e:2===t?(e&255<<s-8)+(o>>8&255):(e&255<<s)+(255&o))).join(".")}inst_addresses.push("127.0.0.1:1234#CFnat");let m=1;if(t.includes("worker")||t.includes("notls")){const f=inst_httpPorts.concat("80");inst_addressesnotls.push(...h.map((e=>l(e)+":"+f[Math.floor(Math.random()*f.length)]+"#CF随机节点"+String(m++).padStart(2,"0"))))}else{const g=inst_httpsPorts.concat("443");inst_addresses.push(...h.map((e=>l(e)+":"+g[Math.floor(Math.random()*g.length)]+"#CF随机节点"+String(m++).padStart(2,"0"))))}}const c=a.toLowerCase();let d="";if(t.includes(".workers.dev")){if(inst_dailihostsURL&&(!inst_dailihosts||0==inst_dailihosts.length))try{const b=await fetch(inst_dailihostsURL);if(!b.ok)return;const y=await b.text(),w=y.split("\n").filter((e=>""!==e.trim()));inst_dailihosts=inst_dailihosts.concat(w)}catch(E){}0!=inst_dailihosts.length&&(d=inst_dailihosts[Math.floor(Math.random()*inst_dailihosts.length)]+"/")}if(c.includes("mozilla")&&!subParams.some((e=>i.searchParams.has(e)))){return config_Html(d,getGeoInfo(r))}return""}function config_Html(e="",t){return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title id="pageTitle">服务配置</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">\n</head>\n<body style="font-family: 'Noto Sans SC', sans-serif; background-color: #f4f7f9; color: #333333; line-height: 1.7;">\n    <div class="container py-4">\n        <div class="card mb-4 rounded-3 shadow position-relative">\n            <div class="card-body text-center p-4">\n                <h1 id="pageHeader" class="display-4 fw-bold text-primary mb-0">🔧 服务配置中心</h1>\n            </div>\n        </div>\n\n        <div id="loading" class="d-flex flex-column align-items-center justify-content-center min-vh-50 text-muted">\n            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>\n            <p>正在加载配置信息...</p>\n        </div>\n\n        <div id="content" class="d-none">\n            <div class="row g-4">\n                <div class="col-12">\n                    <div class="card">\n                        <div class="card-header d-flex justify-content-between align-items-center">\n                            <div class="d-flex align-items-center gap-2">\n                                <span>📋</span>\n                                <span>订阅链接</span>\n                            </div>\n                            <button class="btn btn-primary btn-sm" onclick="openAdvancedSettings()">⚙️ 自定义订阅设置</button>\n                        </div>\n                        <div class="card-body">\n                            <div class="d-flex flex-column gap-3" id="subscriptionLinks"></div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="col-12">\n                    <div class="accordion" id="configAccordion">\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">\n                                    ⚙️ 详细配置信息\n                                </button>\n                            </h2>\n                            <div id="configCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light">\n                                    <div class="d-flex flex-column gap-2" id="configInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#linkCollapse">\n                                    🔗 链接\n                                </button>\n                            </h2>\n                            <div id="linkCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light p-0">\n                                    <div class="p-3" id="linkInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n             <div class="card mt-4">\n                <div class="card-header">\n                    <h5 class="mb-0">📍 Connection Information</h5>\n                </div>\n                <div class="card-body">\n                    ${t?generateGeoHTML(t,!1):""}\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class="text-center py-3 mt-4 text-muted small border-top">\n        <p id="userAgent"></p>\n    </div>\n\n    <div class="modal fade" id="advancedModal" tabindex="-1" aria-hidden="true">\n        <div class="modal-dialog modal-lg">\n            <div class="modal-content rounded-3">\n                <div class="modal-header">\n                    <h3 class="modal-title text-primary">⚙️ 自定义订阅设置</h3>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                </div>\n                <div class="modal-body">\n                    <div class="mb-3">\n                        <div class="form-check d-flex align-items-center mb-2">\n                            <input class="form-check-input me-2" type="checkbox" id="subEnabled">\n                            <label class="form-check-label fw-medium" for="subEnabled">\n                                🚀 优选订阅生成器\n                            </label>\n                        </div>\n                        <input type="text" id="subInput" class="form-control" placeholder="sub.google.com">\n                    </div>\n                    <div class="mb-3">\n                        <div class="form-check d-flex align-items-center mb-2">\n                            <input class="form-check-input me-2" type="checkbox" id="dailiipEnabled">\n                            <label class="form-check-label fw-medium" for="dailiipEnabled">\n                                🌐 dailiIP\n                            </label>\n                        </div>\n                        <input type="text" id="dailiipInput" class="form-control" placeholder="dailiip.cmliussss.net:443">\n                    </div>\n                    <div class="mb-3">\n                        <div class="d-flex align-items-center justify-content-between mb-2">\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="socks5Enabled">\n                                <label class="form-check-label fw-medium" for="socks5Enabled">\n                                    🔒 SOCKS5\n                                </label>\n                            </div>\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="socks5GlobalEnabled">\n                                <label class="form-check-label small text-muted" for="socks5GlobalEnabled">\n                                    全局daili\n                                </label>\n                            </div>\n                        </div>\n                        <input type="text" id="socks5Input" class="form-control" placeholder="user:password@127.0.0.1:1080">\n                    </div>\n                    <div class="mb-3">\n                        <div class="d-flex align-items-center justify-content-between mb-2">\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="httpEnabled">\n                                <label class="form-check-label fw-medium" for="httpEnabled">\n                                    🌍 HTTP\n                                </label>\n                            </div>\n                            <div class="form-check d-flex align-items-center">\n                                <input class="form-check-input me-2" type="checkbox" id="httpGlobalEnabled">\n                                <label class="form-check-label small text-muted" for="httpGlobalEnabled">\n                                    全局daili\n                                </label>\n                            </div>\n                        </div>\n                        <input type="text" id="httpInput" class="form-control" placeholder="34.87.109.175:9443">\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>\n                    <button type="button" class="btn btn-primary" onclick="saveAdvancedSettings()">保存</button>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"><\/script>\n    <script>\n        let configData = null;\n\n        document.addEventListener('DOMContentLoaded', function() {\n            loadConfig();\n        });\n\n        async function loadConfig() {\n            try {\n                const response = await fetch(window.location.pathname + '/config.json?t=' + Date.now());\n                if (!response.ok) {\n                    throw new Error('HTTP error! status: ' + response.status);\n                }\n                \n                configData = await response.json();\n                \n                document.getElementById('loading').classList.add('d-none');\n                document.getElementById('content').classList.remove('d-none');\n                \n                renderSubscriptionLinks();\n                renderLinkInfo();\n                renderConfigInfo();\n                updatePageTitles();\n                \n                document.getElementById('userAgent').textContent = 'User-Agent: ' + configData.UA;\n                \n            } catch (error) {\n                console.error('加载配置失败:', error);\n            }\n        }\n\n        function renderSubscriptionLinks() {\n            const container = document.getElementById('subscriptionLinks');\n            const host = configData.config.HOST;\n            const uuid = configData.config.KEY.UUID;\n            \n            const subscriptions = [\n                { name: '自适应订阅', suffix: '?sub', primary: true },\n                { name: 'Base64订阅', suffix: '?b64', primary: false }\n            ];\n\n            container.innerHTML = '';\n            \n            const primarySub = subscriptions.find(sub => sub.primary);\n            const primaryUrl = buildSubscriptionUrl(host, uuid, primarySub.suffix);\n            \n            const primaryCard = document.createElement('div');\n            primaryCard.className = 'card border p-3';\n            primaryCard.innerHTML = \n                '<h4 class="card-title text-primary mb-2">' + primarySub.name + '</h4>' +\n                '<div class="bg-light border rounded p-2 mb-2 small monospace" style="word-break: break-all; cursor: pointer;">' + primaryUrl + '</div>' +\n                '<div class="d-flex gap-2">' +\n                    '<button class="btn btn-primary btn-sm">📋 复制</button>' +\n                '</div>';\n            \n            const primaryLinkDiv = primaryCard.querySelector('.bg-light');\n            primaryLinkDiv.addEventListener('click', () => copyText(primaryUrl));\n            \n            const primaryCopyBtn = primaryCard.querySelector('.btn-primary');\n            primaryCopyBtn.addEventListener('click', () => copyText(primaryUrl));\n            \n            container.appendChild(primaryCard);\n            \n            const showMoreBtn = document.createElement('button');\n            showMoreBtn.className = 'btn btn-primary mt-2';\n            showMoreBtn.textContent = '📋 更多订阅格式';\n            showMoreBtn.addEventListener('click', toggleAdditionalSubscriptions);\n            container.appendChild(showMoreBtn);\n            \n            const additionalContainer = document.createElement('div');\n            additionalContainer.className = 'd-none mt-2';\n            additionalContainer.id = 'additionalSubscriptions';\n            \n            subscriptions.filter(sub => !sub.primary).forEach((sub, index) => {\n                const url = buildSubscriptionUrl(host, uuid, sub.suffix);\n                \n                const card = document.createElement('div');\n                card.className = 'card border p-3';\n                card.innerHTML = \n                    '<h4 class="card-title text-primary mb-2">' + sub.name + '</h4>' +\n                    '<div class="bg-light border rounded p-2 mb-2 small monospace" style="word-break: break-all; cursor: pointer;">' + url + '</div>' +\n                    '<div class="d-flex gap-2">' +\n                        '<button class="btn btn-primary btn-sm">📋 复制</button>' +\n                    '</div>';\n                \n                const linkDiv = card.querySelector('.bg-light');\n                linkDiv.addEventListener('click', () => copyText(url));\n                \n                const copyBtn = card.querySelector('.btn-primary');\n                copyBtn.addEventListener('click', () => copyText(url));\n                \n                additionalContainer.appendChild(card);\n            });\n            \n            container.appendChild(additionalContainer);\n        }\n\n        function buildSubscriptionUrl(host, uuid, suffix) {\n            let baseUrl = 'https://${e}' + host + '/' + uuid + suffix;\n            \n            const settings = getAdvancedSettings();\n            const params = [];\n            \n            if (settings.subEnabled && settings.subValue) {\n                if (suffix === '?sub') {\n                    baseUrl = 'https://${e}' + host + '/' + uuid + '?sub=' + encodeURIComponent(settings.subValue);\n                } else {\n                    params.push('sub=' + encodeURIComponent(settings.subValue));\n                }\n            }\n            \n            if (settings.dailiipEnabled && settings.dailiipValue) {\n                params.push('dailiip=' + encodeURIComponent(settings.dailiipValue));\n            } else if (settings.socks5Enabled && settings.socks5Value) {\n                params.push('socks5=' + encodeURIComponent(settings.socks5Value));\n                if (settings.socks5GlobalEnabled) {\n                    params.push('globaldaili');\n                }\n            } else if (settings.httpEnabled && settings.httpValue) {\n                params.push('http=' + encodeURIComponent(settings.httpValue));\n                if (settings.httpGlobalEnabled) {\n                    params.push('globaldaili');\n                }\n            }\n            \n            if (params.length > 0) {\n                const separator = baseUrl.includes('?') ? '&' : '?';\n                return baseUrl + separator + params.join('&');\n            }\n            \n            return baseUrl;\n        }\n\n        function toggleAdditionalSubscriptions() {\n            const additionalContainer = document.getElementById('additionalSubscriptions');\n            const showMoreBtn = document.querySelector('.btn-primary.mt-2');\n            \n            if (additionalContainer.classList.contains('d-block')) {\n                additionalContainer.classList.remove('d-block');\n                additionalContainer.classList.add('d-none');\n                showMoreBtn.textContent = '📋 更多订阅格式';\n            } else {\n                additionalContainer.classList.remove('d-none');\n                additionalContainer.classList.add('d-block');\n                showMoreBtn.textContent = '📋 收起订阅格式';\n            }\n        }\n\n        function renderLinkInfo() {\n            const container = document.getElementById('linkInfo');\n            const v2Link = configData.link.v2;\n\n            const v2Card = document.createElement('div');\n            v2Card.className = 'card border-start border-success border-3 p-3 mb-3';\n            v2Card.innerHTML = \n                '<div class="fw-bold text-success h5 mb-2">v2 链接</div>' +\n                '<div class="small monospace bg-light p-2 rounded" style="word-break: break-all; cursor: pointer;">' + v2Link + '</div>';\n            \n            const v2Content = v2Card.querySelector('.bg-light');\n            v2Content.addEventListener('click', () => copyText(v2Link));\n            container.innerHTML = '';\n            container.appendChild(v2Card);\n        }\n\n        function renderConfigInfo() {\n            const container = document.getElementById('configInfo');\n            const config = configData.config;\n            \n            let configItems = [\n                { label: 'HOST', value: config.HOST },\n                { label: 'UUID', value: config.KEY.UUID },\n                { label: '跳过TLS验证', value: config.SCV === 'true' ? '✅ 启用' : '❌ 禁用' }\n            ];\n\n            container.innerHTML = configItems.map(item => (\n                '<div class="bg-light rounded p-2 border-start border-primary border-3">' +\n                    '<div class="small text-muted fw-medium mb-1">' + item.label + '</div>' +\n                    '<div class="small fw-semibold monospace">' + item.value + '</div>' +\n                '</div>'\n            )).join('');\n        }\n\n        function updatePageTitles() {\n            const subName = configData.sub.SUBNAME;\n            if (subName) {\n                document.getElementById('pageTitle').textContent = subName + ' 配置';\n                document.getElementById('pageHeader').textContent = '🔧 ' + subName + ' 配置中心';\n            }\n        }\n\n        function copyText(text) {\n            navigator.clipboard.writeText(text).then(() => {\n                showToast('✅ 已复制到剪贴板');\n            }).catch(err => {\n                console.error('复制失败:', err);\n                showToast('❌ 复制失败');\n            });\n        }\n\n        function showToast(message, duration = 3000) {\n            const toast = document.createElement('div');\n            toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);';\n            toast.textContent = message;\n            document.body.appendChild(toast);\n            \n            setTimeout(() => {\n                toast.remove();\n            }, duration);\n        }\n\n        function openAdvancedSettings() {\n            loadAdvancedSettings();\n            new bootstrap.Modal(document.getElementById('advancedModal')).show();\n        }\n\n        function loadAdvancedSettings() {\n            const settings = getAdvancedSettings();\n            \n            document.getElementById('subEnabled').checked = settings.subEnabled;\n            document.getElementById('subInput').value = settings.subValue;\n            document.getElementById('subInput').disabled = !settings.subEnabled;\n            \n            document.getElementById('dailiipEnabled').checked = settings.dailiipEnabled;\n            document.getElementById('dailiipInput').value = settings.dailiipValue;\n            document.getElementById('dailiipInput').disabled = !settings.dailiipEnabled;\n            \n            document.getElementById('socks5Enabled').checked = settings.socks5Enabled;\n            document.getElementById('socks5Input').value = settings.socks5Value;\n            document.getElementById('socks5Input').disabled = !settings.socks5Enabled;\n            document.getElementById('socks5GlobalEnabled').checked = settings.socks5GlobalEnabled;\n            document.getElementById('socks5GlobalEnabled').disabled = !settings.socks5Enabled;\n            \n            document.getElementById('httpEnabled').checked = settings.httpEnabled;\n            document.getElementById('httpInput').value = settings.httpValue;\n            document.getElementById('httpInput').disabled = !settings.httpEnabled;\n            document.getElementById('httpGlobalEnabled').checked = settings.httpGlobalEnabled;\n            document.getElementById('httpGlobalEnabled').disabled = !settings.httpEnabled;\n        }\n\n        function getAdvancedSettings() {\n            const settings = localStorage.getItem('advancedSubscriptionSettings');\n            if (settings) {\n                return JSON.parse(settings);\n            }\n            return {\n                subEnabled: false,\n                subValue: '',\n                dailiipEnabled: false,\n                dailiipValue: '',\n                socks5Enabled: false,\n                socks5Value: '',\n                socks5GlobalEnabled: false,\n                httpEnabled: false,\n                httpValue: '',\n                httpGlobalEnabled: false\n            };\n        }\n        \n        function formatSocks5Input(input) {\n            if (!input) return input;\n            let formatted = input.trim()\n                .replace(/^socks5?:\\/\\//, '')  \n                .replace(/\\/$/, '')            \n                .replace(/#.*$/, ''); \n            return formatted;\n        }\n        \n        function formatHttpInput(input) {\n            if (!input) return input;\n            let formatted = input.trim()\n                .replace(/^https?:\\/\\//, '')   \n                .replace(/\\/$/, '')            \n                .replace(/#.*$/, '');\n            return formatted;\n        }\n\n        function saveAdvancedSettings() {\n            const socks5Value = formatSocks5Input(document.getElementById('socks5Input').value);\n            const httpValue = formatHttpInput(document.getElementById('httpInput').value);\n            \n            document.getElementById('socks5Input').value = socks5Value;\n            document.getElementById('httpInput').value = httpValue;\n            \n            const settings = {\n                subEnabled: document.getElementById('subEnabled').checked,\n                subValue: document.getElementById('subInput').value,\n                dailiipEnabled: document.getElementById('dailiipEnabled').checked,\n                dailiipValue: document.getElementById('dailiipInput').value,\n                socks5Enabled: document.getElementById('socks5Enabled').checked,\n                socks5Value: socks5Value,\n                socks5GlobalEnabled: document.getElementById('socks5GlobalEnabled').checked,\n                httpEnabled: document.getElementById('httpEnabled').checked,\n                httpValue: httpValue,\n                httpGlobalEnabled: document.getElementById('httpGlobalEnabled').checked\n            };\n            \n            localStorage.setItem('advancedSubscriptionSettings', JSON.stringify(settings));\n            \n            bootstrap.Modal.getInstance(document.getElementById('advancedModal')).hide();\n            \n            renderSubscriptionLinks();\n            showToast('🎉 设置已保存！请重新复制上方更新后的订阅链接，才能使自定义设置生效哦~', 5000);\n        }\n\n        function updateSettings() {\n            const enabled = document.getElementById('subEnabled').checked;\n            document.getElementById('subInput').disabled = !enabled;\n        }\n\n        function updatedailiSettings(type) {\n            const enabled = document.getElementById(type + 'Enabled').checked;\n            \n            if (enabled) {\n                const dailiTypes = ['dailiip', 'socks5', 'http'];\n                dailiTypes.forEach(dailiType => {\n                    if (dailiType !== type) {\n                        document.getElementById(dailiType + 'Enabled').checked = false;\n                        document.getElementById(dailiType + 'Input').disabled = true;\n                        \n                        if (dailiType === 'socks5' || dailiType === 'http') {\n                            const globalCheckbox = document.getElementById(dailiType + 'GlobalEnabled');\n                            if (globalCheckbox) {\n                                globalCheckbox.checked = false;\n                                globalCheckbox.disabled = true;\n                            }\n                        }\n                    }\n                });\n            }\n            \n            document.getElementById(type + 'Input').disabled = !enabled;\n            \n            if (type === 'socks5' || type === 'http') {\n                const globalCheckbox = document.getElementById(type + 'GlobalEnabled');\n                if (globalCheckbox) {\n                    globalCheckbox.disabled = !enabled;\n                    if (!enabled) {\n                        globalCheckbox.checked = false;\n                    }\n                }\n            }\n        }\n\n        document.getElementById('subEnabled').addEventListener('change', updateSettings);\n        document.getElementById('dailiipEnabled').addEventListener('change', () => updatedailiSettings('dailiip'));\n        document.getElementById('socks5Enabled').addEventListener('change', () => updatedailiSettings('socks5'));\n        document.getElementById('httpEnabled').addEventListener('change', () => updatedailiSettings('http'));\n    <\/script>\n</body>\n</html>`}
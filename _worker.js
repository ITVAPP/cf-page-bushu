import{connect as _socket_connect}from"cloudflare:sockets";const _K={UPG:atob("VXBncmFkZQ=="),WS:atob("d2Vic29ja2V0"),DE:atob("aHR0cHM6Ly8xLjEuMS4xL2Rucy1xdWVyeQ=="),DM:atob("YXBwbGljYXRpb24vZG5zLW1lc3NhZ2U=")},EXPIRE_TIMESTAMP=4102329600,DEFAULT_DLS=8,DEFAULT_REMARK_INDEX=1,DEFAULT_FILENAME=atob("WmlwVg=="),DEFAULT_PATH="/api/data",HTTP_PORTS=["8080","8880","2052","2082","2086","2095"],HTTPS_PORTS=["2053","2083","2087","2096","8443"],FAKE_API_PATHS={primary:"/api/data",alternatives:["/api/v1/stream","/api/v1/analytics","/api/v1/metrics","/api/v2/events","/ws/realtime","/stream/live"]},NORMAL_API_ENDPOINTS=["/api/v1/user","/api/v1/posts","/api/v1/health","/api/v1/status","/api/version"],UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,IPV4_REGEX=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,globalDecoder=new TextDecoder;let inst_userID="",inst_addresses=[],inst_addressesapi=[],inst_addressesnotls=[],inst_addressesnotlsapi=[],inst_addressescsv=[],inst_DLS=8,inst_remarkIndex=1,inst_FileName=DEFAULT_FILENAME,inst_httpPorts=[...HTTP_PORTS],inst_httpsPorts=[...HTTPS_PORTS],inst_banKeywords=[],inst_banKeywordsLower=[],inst_banKeywordsRegex=null,inst_SCV="true",inst_allowInsecure="&allowInsecure=1",inst_GatewayUA="",inst_rateLimitMap=new Map;const RATE_LIMIT_WINDOW=6e4;let inst_maxRequestsPerMinute=80,inst_lastRateLimitCleanup=0,isInstanceInitialized=!1;const simpleDnsCache=new Map,SIMPLE_CACHE_TTL=36e5,SIMPLE_CACHE_MAX_SIZE=1e3;async function initializeInstance(e){if(isInstanceInitialized)return;inst_userID=e.UUID||e.uuid||e.PASSWORD||e.pswd||"";const t=[];if(e.CFPORTS&&t.push(processList(e.CFPORTS).then((e=>{inst_httpsPorts=e}))),e.BAN_KEYWORDS&&""!==e.BAN_KEYWORDS.trim()&&t.push(processList(e.BAN_KEYWORDS).then((e=>{if(inst_banKeywords=e,inst_banKeywords.length>0){const e=inst_banKeywords.filter((e=>e&&e.trim()));if(e.length>0){inst_banKeywordsLower=e.map((e=>e.toLowerCase()));const t=e.map((e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))).join("|");inst_banKeywordsRegex=new RegExp(t,"i")}}}))),e.ADD&&t.push(processList(e.ADD).then((e=>{inst_addresses=e}))),e.ADDAPI&&t.push(processList(e.ADDAPI).then((e=>{inst_addressesapi=e}))),e.ADDNOTLS&&t.push(processList(e.ADDNOTLS).then((e=>{inst_addressesnotls=e}))),e.ADDNOTLSAPI&&t.push(processList(e.ADDNOTLSAPI).then((e=>{inst_addressesnotlsapi=e}))),e.ADDCSV&&t.push(processList(e.ADDCSV).then((e=>{inst_addressescsv=e}))),await Promise.all(t),inst_DLS=Number(e.DLS)||inst_DLS,inst_remarkIndex=Number(e.CSVREMARK)||inst_remarkIndex,inst_FileName=e.SUBNAME||inst_FileName,inst_GatewayUA=e.DAILI_UA||"",inst_SCV=e.SCV||inst_SCV,inst_SCV&&"0"!=inst_SCV&&"false"!=inst_SCV?inst_SCV="true":inst_allowInsecure="",e.RATE_LIMIT){const t=Number(e.RATE_LIMIT);t>0&&(inst_maxRequestsPerMinute=t)}isInstanceInitialized=!0}function addNormalHeaders(e,t=!0){return e["X-Content-Type-Options"]="nosniff",e["X-Frame-Options"]="SAMEORIGIN",e["Referrer-Policy"]="strict-origin-when-cross-origin",t&&(e["Cache-Control"]="public, max-age=3600",e.Vary="Accept-Encoding"),e}function getGeoInfo(e){const t=e.headers.get("cf-connecting-ipv6")||e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"0.0.0.0",n=e.headers.get("cf-ray"),a=n?n.split("-")[1]:null;return{ip:t,country:e.cf?.country||e.headers.get("cf-ipcountry")||"N/A",countryRegion:e.cf?.region||e.headers.get("cf-region")||"N/A",city:e.cf?.city||e.headers.get("cf-ipcity")||"N/A",region:e.cf?.colo||a||"N/A",latitude:null!=e.cf?.latitude?String(e.cf.latitude):e.headers.get("cf-iplatitude")||"N/A",longitude:null!=e.cf?.longitude?String(e.cf.longitude):e.headers.get("cf-iplongitude")||"N/A",asOrganization:e.cf?.asOrganization||e.headers.get("x-asn")||"N/A",timezone:e.cf?.timezone||"N/A",asn:e.cf?.asn||"N/A"}}function generateFakeAPIResponse(e,t){const n=(new Date).toISOString(),a=getGeoInfo(t);switch(e){case"/api/v1/user":return{success:!0,data:{id:Math.random().toString(36).substr(2,9),username:"user_"+Math.floor(1e4*Math.random()),created_at:n,last_login:n},timestamp:n};case"/api/v1/posts":return{success:!0,data:{posts:Array.from({length:5},((e,t)=>({id:t+1,title:`Post ${t+1}`,created_at:n}))),total:5,page:1},timestamp:n};case"/api/v1/health":return{status:"healthy",uptime:Math.floor(86400*Math.random()),version:"1.2.3",timestamp:n};case"/api/v1/status":return{operational:!0,services:{api:"online",database:"online",cache:"online"},region:a.region,timestamp:n};case"/api/version":return{version:"1.2.3",build:"production",commit:Math.random().toString(36).substr(2,7),timestamp:n};default:return{error:"Not Found",message:"The requested endpoint does not exist",timestamp:n}}}function isGatewayPath(e,t){return e===t||e===FAKE_API_PATHS.primary||!!FAKE_API_PATHS.alternatives.includes(e)}function generateFakeRejection(e="invalid_token"){return new Response(JSON.stringify({success:!1,error:e,message:"connection requires valid authentication token",timestamp:(new Date).toISOString()}),{status:401,headers:{"Content-Type":"application/json","WWW-Authenticate":'Bearer realm="API"',"X-RateLimit-Limit":"100","X-RateLimit-Remaining":Math.floor(100*Math.random()).toString(),"X-RateLimit-Reset":String(Date.now()+36e5)}})}function generateGeoHTML(e,t=!1){const n=`\n        <tr><th>IP Address</th><td><code>${e.ip}</code></td></tr>\n        <tr><th>Country</th><td>${e.country}</td></tr>\n        <tr><th>Region</th><td>${e.countryRegion}</td></tr>\n        <tr><th>City</th><td>${e.city}</td></tr>\n        <tr><th>Data Center (Colo)</th><td>${e.region}</td></tr>\n        <tr><th>Latitude</th><td>${e.latitude}</td></tr>\n        <tr><th>Longitude</th><td>${e.longitude}</td></tr>\n        <tr><th>ASN</th><td>${e.asn}</td></tr>\n        <tr><th>Organization</th><td>${e.asOrganization}</td></tr>\n        <tr><th>Timezone</th><td>${e.timezone}</td></tr>\n    `;return t?`\n            <!DOCTYPE html>\n            <html lang="en">\n            <head>\n                <meta charset="UTF-8">\n                <meta name="viewport" content="width=device-width, initial-scale=1.0">\n                <title>IP Geolocation API</title>\n                <style>\n        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f7f9; margin: 0; padding: 20px; }\n        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n        h1, h2 { color: #007bff; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n        th { background-color: #f8f9fa; }\n        code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n        .footer { text-align: center; margin-top: 20px; font-size: 0.9em; color: #777; }\n        .api-info { margin-top: 30px; }\n        .api-info pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; overflow-x: auto; }\n    </style>\n            </head>\n            <body>\n                <div class="container">\n                    <h1>IP Geolocation API</h1>\n                    <p>Your current connection details:</p>\n                    <table>${n}</table>\n                    <div class="api-info">\n                        <h2>API Usage</h2>\n                        <p>To get this information in JSON format, make a request to <code>/geo</code>.</p>\n                        <p>Example response:</p>\n                        <pre>${JSON.stringify(e,null,2)}</pre>\n                    </div>\n                </div>\n            </body>\n            </html>\n        `:`<table style="width: 100%; margin: 0 auto; text-align: left; border: 1px solid #ddd;">${n}</table>`}function checkRateLimit(e){const t=Date.now();if(inst_rateLimitMap.size>5e3||inst_rateLimitMap.size>1e3&&t-inst_lastRateLimitCleanup>6e4){inst_lastRateLimitCleanup=t;for(const[e,n]of inst_rateLimitMap){if(!(t-n.timestamp>6e4))break;inst_rateLimitMap.delete(e)}}const n=inst_rateLimitMap.get(e);return!n||t-n.timestamp>6e4?(n&&inst_rateLimitMap.delete(e),inst_rateLimitMap.set(e,{count:1,timestamp:t}),!0):(n.count++,n.count<=inst_maxRequestsPerMinute)}function containsBannedKeyword(e){if(!inst_banKeywords||0===inst_banKeywords.length)return!1;if(inst_banKeywordsRegex)return inst_banKeywordsRegex.test(e);const t=e.toLowerCase();for(const e of inst_banKeywordsLower)if(t.includes(e))return!0;return!1}function timeoutPromise(e,t){return new Promise(((n,a)=>setTimeout((()=>a(new Error(t))),e)))}function convertToNAT64IPv6(e){const t=e.split(".");if(4!==t.length)return null;const n=t.map((e=>parseInt(e,10).toString(16).padStart(2,"0")));return`[2602:fc59:b0:64::${n[0]}${n[1]}:${n[2]}${n[3]}]`}export default{async fetch(e,t,n){isInstanceInitialized||await initializeInstance(t);try{if(!checkRateLimit(e.headers.get("cf-connecting-ip")||e.headers.get("x-real-ip")||"unknown"))return new Response("Too Many Requests",{status:429,headers:{"Content-Type":"text/plain; charset=UTF-8","Retry-After":"60"}});const n=e.headers.get("User-Agent")||"null",a=n.toLowerCase();if(!inst_userID||!validateKey(inst_userID))return new Response("Please configure your UUID variable, or try redeploying to check if the variable is effective.",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});const s=e.headers.get(_K.UPG),r=new URL(e.url);if(s&&s===_K.WS){if(inst_GatewayUA&&""!==inst_GatewayUA.trim()){const t=(e.headers.get("App-Client")||"").toLowerCase(),n=inst_GatewayUA.toLowerCase();if(!a.includes(n)&&!t.includes(n))return new Response("Forbidden: Access Denied via Restriction",{status:403,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}return isGatewayPath(r.pathname.toLowerCase(),"/api/data")?await connectionHandler(e,{userID:inst_userID}):generateFakeRejection("invalid_endpoint")}{let s="/api/data",o="false";r.searchParams.has("notls")&&(o="true");const i=r.pathname.toLowerCase();if(NORMAL_API_ENDPOINTS.includes(i)){const t=generateFakeAPIResponse(i,e),n=t.error?404:200;return new Response(JSON.stringify(t,null,2),{status:n,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.2.3","X-Request-ID":Math.random().toString(36).substr(2,16)})})}if("/"==i){if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await linkFetcher(t.URL,r);const n=generateGeoHTML(getGeoInfo(e),!0);return new Response(n,{status:200,headers:addNormalHeaders({"Content-Type":"text/html; charset=UTF-8"})})}if("/geo"===i){return createJSONResponse(getGeoInfo(e))}if(i==`/${inst_userID}/config.json`){const a=t.SUB||"";return await apiConfig(inst_userID,e.headers.get("Host"),a,n,r,t)}if("/getusage"!==i&&i!==`/${inst_userID}/getusage`){if(r.pathname==`/${inst_userID}`){const s=t.SUB||"",o=await renderPage(inst_userID,e.headers.get("Host"),s,n,r,t,e),i=Date.now(),c=new Date(i);c.setHours(0,0,0,0);const l=Math.floor((i-c.getTime())/864e5*24*1099511627776/2);let d=l,u=l,p=26388279066624;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{const e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL);p=t.CF_ALL?Number(t.CF_ALL):1e5;d=p-e,u=e}catch(e){}return a&&a.includes("mozilla")?new Response(o,{status:200,headers:addNormalHeaders({"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${u}; total=${p}; expire=4102329600`,"Cache-Control":"no-store"},!1)}):new Response(o,{status:200,headers:addNormalHeaders({"Content-Disposition":`attachment; filename=${inst_FileName}; filename*=utf-8''${encodeURIComponent(inst_FileName)}`,"Profile-Update-Interval":"6","Profile-web-page-url":e.url.includes("?")?e.url.split("?")[0]:e.url,"Subscription-Userinfo":`upload=${d}; download=${u}; total=${p}; expire=4102329600`},!1)})}if(isGatewayPath(i,s)){const e={success:!0,message:"Data endpoint ready",version:"1.0.0",timestamp:(new Date).toISOString(),endpoints:{websocket:"wss://example.com/api/data",status:"/api/v1/status",health:"/api/v1/health"}};return new Response(JSON.stringify(e,null,2),{status:200,headers:addNormalHeaders({"Content-Type":"application/json; charset=UTF-8","X-API-Version":"1.0.0","X-Content-Type-Options":"nosniff"})})}{if(t.URL302)return Response.redirect(t.URL302,302);if(t.URL)return await linkFetcher(t.URL,r);const n=`\n                        <!DOCTYPE html>\n                        <html lang="en">\n                        <head>\n                            <meta charset="UTF-8">\n                            <title>403 Forbidden</title>\n                            <style>\n                                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }\n                                .container { max-width: 800px; margin: 2em auto; padding: 1em; }\n                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n                                th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }\n                                th { background-color: #f8f9fa; }\n                                code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }\n                            </style>\n                        </head>\n                        <body>\n                            <div class="container">\n                                <h1>403 Forbidden</h1>\n                                <p>Access Denied: You do not have permission to access this resource.</p>\n                                <hr>\n                                ${generateGeoHTML(getGeoInfo(e),!1).replace("<table",'<table style="width:100%;"')}\n                            </div>\n                        </body>\n                        </html>\n                    `;return new Response(n,{status:403,headers:{"Content-Type":"text/html; charset=UTF-8"}})}}try{let e=0,n=1e5;if(t.CF_EMAIL&&t.CF_APIKEY||t.CF_ID&&t.CF_APITOKEN)try{e=await getUsage(t.CF_ID,t.CF_EMAIL,t.CF_APIKEY,t.CF_APITOKEN,t.CF_ALL),n=t.CF_ALL?Number(t.CF_ALL):1e5}catch(t){const a=Date.now(),s=new Date(a);s.setHours(0,0,0,0);const r=(a-s.getTime())/864e5,o=Math.floor(n*r*.5);e=Math.max(0,n-o)}else{const t=Date.now(),a=new Date(t);a.setHours(0,0,0,0);const s=(t-a.getTime())/864e5,r=Math.floor(n*s*.5);e=Math.max(0,n-r)}const a=n-e;return createJSONResponse({success:!0,data:{total:n,used:a,remaining:e,percentage:(a/n*100).toFixed(2)+"%"},timestamp:(new Date).toISOString()},200,{"Cache-Control":"no-cache"})}catch(e){return createJSONResponse({success:!1,error:e.message||"Unknown error",timestamp:(new Date).toISOString()},500,{"Cache-Control":"no-cache"})}}}catch(e){return new Response(`Internal Server Error: ${e.message}`,{status:500,headers:{"Content-Type":"text/plain; charset=UTF-8"}})}}};async function connectionHandler(e,t){const n=new WebSocketPair,[a,s]=Object.values(n);s.accept();let r="",o="";const i=(e,t)=>{},c=e.headers.get("sec-websocket-protocol")||"",l=createReadableStream(s,c,i);let d={value:null},u=null,p=!1;return l.pipeTo(new WritableStream({async write(e,n){if(p&&u)return u(e);if(d.value){const t=d.value.writable.getWriter();try{await t.write(e)}catch(e){safeClosedate(d.value)}finally{t.releaseLock()}return}const{hasError:a,message:c,addressType:l,portRemote:f=443,addressRemote:h="",rawDataIndex:m,zipvVersion:g=new Uint8Array([0,0]),isUDP:y}=parseHeader(e,t.userID);if(r=h,o=`${f}--${Math.random()} ${y?"udp ":"tcp "} `,a)throw new Error(c);if(y){if(53!==f)throw new Error("Service unavailable for this port");p=!0}const b=new Uint8Array([g[0],0]),w=e.slice(m);if(p){const{write:e}=await handleOutbound(s,b,i);return u=e,void u(w)}if(containsBannedKeyword(h))throw new Error(`Blocked connection to ${h}:${f}`);handleDataOut(d,h,f,w,s,b,i)},close(){},abort(e){}})).catch((e=>{})),new Response(null,{status:101,webSocket:a})}async function handleDataOut(e,t,n,a,s,r,o){async function i(e){if(/^(\d{1,3}\.){3}\d{1,3}$/.test(e))return convertToNAT64IPv6(e);if(/^\[.*\]$/.test(e)||e.split(":").length>2)return e;const t=Date.now(),n=simpleDnsCache.get(e);if(n&&n.expire>t)return n.ip;try{const n=new AbortController,a=setTimeout((()=>n.abort()),1e3),s=await fetch(`https://1.1.1.1/dns-query?name=${e}&type=A`,{headers:{Accept:"application/dns-json"},signal:n.signal});clearTimeout(a);const r=await s.json();if(r.Answer&&r.Answer.length>0){const n=r.Answer.find((e=>1===e.type))?.data;if(n){const a=convertToNAT64IPv6(n);if(simpleDnsCache.size>=SIMPLE_CACHE_MAX_SIZE){const e=simpleDnsCache.keys().next().value;simpleDnsCache.delete(e)}return simpleDnsCache.set(e,{ip:a,expire:t+SIMPLE_CACHE_TTL}),a}}}catch(e){}return e}async function c(c){try{let l;l=c?await c:await i(t);const d=await Promise.race([_socket_connect({hostname:l,port:n}),timeoutPromise(2e3,"IPv6 Retry Timeout")]);e.value=d;const u=d.writable.getWriter();await u.write(a),u.releaseLock(),streamRelay(d,s,r,null,o)}catch(e){safeClosedate(s)}}let l=null;/^(\d{1,3}\.){3}\d{1,3}$/.test(t)||/^\[.*\]$/.test(t)||(l=i(t));try{const i=await Promise.race([_socket_connect({hostname:t,port:n}),timeoutPromise(1e3,"Direct Timeout")]);e.value=i;const d=i.writable.getWriter();await d.write(a),d.releaseLock(),streamRelay(i,s,r,(()=>c(l)),o)}catch(e){await c(l)}}function createReadableStream(e,t,n){let a=!1;return new ReadableStream({start(n){e.addEventListener("message",(e=>{if(a)return;const t=e.data;n.enqueue(t)})),e.addEventListener("close",(()=>{safeClosedate(e),a||n.close()})),e.addEventListener("error",(e=>{n.error(e)}));const{earlyData:s,error:r}=base64ToArrayBuffer(t);r?n.error(r):s&&n.enqueue(s)},pull(e){},cancel(t){a||(a=!0,safeClosedate(e))}})}function parseHeader(e,t){const n=e instanceof Uint8Array?e:new Uint8Array(e);if(n.byteLength<24)return{hasError:!0,message:"invalid data"};const a=n.subarray(0,1);let s=!1,r=!1;const o=n.subarray(1,17);if(s=stringify(o)===t,!s)return{hasError:!0,message:`invalid user ${o}`};const i=n[17],c=n[18+i];if(1!==c){if(2!==c)return{hasError:!0,message:`command ${c} is not support, command 01-tcp,02-udp,03-mux`};r=!0}const l=18+i+1,d=new DataView(n.buffer,n.byteOffset+l,2).getUint16(0);let u=l+2;const p=n[u];let f=0,h=u+1,m="";switch(p){case 1:f=4,m=n.subarray(h,h+f).join(".");break;case 2:f=n[h],h+=1,m=globalDecoder.decode(n.subarray(h,h+f));break;case 3:f=16;const e=new DataView(n.buffer,n.byteOffset+h,f),t=[];for(let n=0;n<8;n++)t.push(e.getUint16(2*n).toString(16));m=t.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return m?{hasError:!1,addressRemote:m,addressType:p,portRemote:d,rawDataIndex:h+f,zipvVersion:a,isUDP:r}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}function streamRelay(e,t,n,a,s){let r=n,o=!1,i=null;a&&(i=setTimeout((()=>{o||safeClosedate(e)}),1e3)),e.readable.pipeTo(new WritableStream({async write(e){if(i&&(clearTimeout(i),i=null),o=!0,1===t.readyState)if(r){const n=new Uint8Array(r.length+e.byteLength);n.set(r),n.set(new Uint8Array(e),r.length),t.send(n.buffer),r=null}else t.send(e)},close(){i&&clearTimeout(i),o||!a?1===t.readyState&&t.close(1e3,"Normal closure"):a()},abort(e){i&&clearTimeout(i),safeClosedate(t)}})).catch((e=>{i&&clearTimeout(i),!o&&a?a():safeClosedate(t)}))}function base64ToArrayBuffer(e){if(!e)return{earlyData:void 0,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{earlyData:void 0,error:e}}}function validateKey(e){return UUID_REGEX.test(e)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeClosedate(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){}}const byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]}function stringify(e,t=0){const n=unsafeStringify(e,t);if(!validateKey(n))throw TypeError(`Generated UUID does not conform to specification ${n}`);return n}async function handleOutbound(e,t,n){let a=!1;const s=new TransformStream({start(e){},transform(e,t){for(let n=0;n<e.byteLength;){const a=e.slice(n,n+2),s=new DataView(a).getUint16(0),r=new Uint8Array(e.slice(n+2,n+2+s));n=n+2+s,t.enqueue(r)}},flush(e){}});s.readable.pipeTo(new WritableStream({async write(n){const s=await fetch(_K.DE,{method:"POST",headers:{"content-type":_K.DM},body:n}),r=await s.arrayBuffer(),o=r.byteLength,i=new Uint8Array([o>>8&255,255&o]);1===e.readyState&&(a?e.send(await new Blob([i,r]).arrayBuffer()):(e.send(await new Blob([t,i,r]).arrayBuffer()),a=!0))}})).catch((e=>{}));const r=s.writable.getWriter();return{write(e){r.write(e)}}}async function linkFetcher(e,t){const n=await processList(e),a=n[Math.floor(Math.random()*n.length)];let s=new URL(a),r=s.protocol.slice(0,-1)||"https",o=s.hostname,i=s.pathname,c=s.search;"/"==i.charAt(i.length-1)&&(i=i.slice(0,-1)),i+=t.pathname;let l=`${r}://${o}${i}${c}`,d=await fetch(l),u=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return u.headers.set("X-New-URL",l),u}function createJSONResponse(e,t=200,n={}){return new Response(JSON.stringify(e,null,2),{status:t,headers:{"Content-Type":"application/json; charset=UTF-8","Access-Control-Allow-Origin":"*",...n}})}async function processList(e){const t=e.replace(/[\t"'\r\n]+/g,",").replace(/,+/g,",").replace(/^,|,$/g,"");return t?t.split(","):[]}function isValidIPv4(e){return IPV4_REGEX.test(e)}async function getUsage(e,t,n,a,s=1e5){try{if(!e){if(!t||!n)throw new Error("Missing required authentication info: email and apikey cannot be empty");e=await async function(e,t){const n=await fetch("https://api.cloudflare.com/client/v4/accounts",{method:"GET",headers:{"Content-Type":"application/json","X-AUTH-EMAIL":e,"X-AUTH-KEY":t}});if(!n.ok){const e=await n.text();throw new Error(`Cloudflare API request failed: ${n.status} ${n.statusText} - ${e}`)}const a=await n.json();let s=0,r=!1;if(a?.result&&a.result.length>1){const t=e.toLowerCase();for(let e=0;e<a.result.length;e++)if((a.result[e]?.name?.toLowerCase()||"").startsWith(t)){s=e,r=!0;break}}else a?.result&&1===a.result.length&&(r=!0);const o=a?.result?.[s]?.id;if(!o)throw new Error("Valid account ID not found, please check API permissions");return o}(t,n)}const r=new Date,o=r.toISOString();r.setUTCHours(0,0,0,0);const i=r.toISOString();let c;if(n&&t)c={"Content-Type":"application/json","X-AUTH-EMAIL":t,"X-AUTH-KEY":n};else{if(!a)throw new Error("Missing authentication info: need (email+apikey) or apitoken");c={"Content-Type":"application/json",Authorization:`Bearer ${a}`}}const l=await fetch("https://api.cloudflare.com/client/v4/graphql",{method:"POST",headers:c,body:JSON.stringify({query:"query getBillingMetrics($accountId: String!, $filter: AccountWorkersInvocationsAdaptiveFilter_InputObject) {\n                    viewer {\n                        accounts(filter: {accountTag: $accountId}) {\n                            pagesFunctionsInvocationsAdaptiveGroups(limit: 1000, filter: $filter) {\n                                sum { requests }\n                            }\n                            workersInvocationsAdaptive(limit: 10000, filter: $filter) {\n                                sum { requests }\n                            }\n                        }\n                    }\n                }",variables:{accountId:e,filter:{datetime_geq:i,datetime_leq:o}}})});if(!l.ok){const e=await l.text();throw new Error(`GraphQL API request failed: ${l.status} - ${e}`)}const d=await l.json();if(d.errors&&d.errors.length>0){const e=d.errors[0].message||"Unknown GraphQL error";throw new Error(`GraphQL error: ${e}`)}const u=d?.data?.viewer?.accounts?.[0];if(!u)return 0;const p=(u?.pagesFunctionsInvocationsAdaptiveGroups||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0),f=(u?.workersInvocationsAdaptive||[]).reduce(((e,t)=>e+(t?.sum?.requests||0)),0);return Math.max(0,(Number(s)||1e5)-(p+f))}catch(e){throw e}}const hunxiao=atob("ZG14bGMzTT0=");async function apiConfig(e,t,n,a,s,r){let o=t;return createJSONResponse({timestamp:(new Date).toISOString(),config:{HOST:t,KEY:{UUID:e.toLowerCase()||null},SCV:inst_SCV},sub:{SUBNAME:inst_FileName,SUB:n&&"local"!=n?n:"local",ADD:inst_addresses,ADDNOTLS:inst_addressesnotls,ADDAPI:inst_addressesapi,ADDNOTLSAPI:inst_addressesnotlsapi,ADDCSV:inst_addressescsv,DLS:inst_DLS,CSVREMARK:inst_remarkIndex},link:{v2:`${atob(hunxiao)}://${e.toLowerCase()}@${o}:443?encryp${atob("dGlvbj0=")}none&security=tls&sni=${o}&fp=chrome&type=ws&host=${t}&path=${encodeURIComponent("/api/data")+inst_allowInsecure}&fragment=${encodeURIComponent("1,40-60,30-50,tlshello")}#${encodeURIComponent(inst_FileName)}`},KV:!!r.KV,UA:a||null},200,{"Cache-Control":"no-cache"})}async function renderPage(e,t,n,a,s,r,o){if(inst_addresses.length+inst_addressesapi.length+inst_addressesnotls.length+inst_addressesnotlsapi.length+inst_addressescsv.length==0){let c=["104.16.0.0/13"];function i(e){const[t,n]=e.split("/"),a=t.split(".").map(Number),s=32-parseInt(n,10),r=Math.pow(2,s)-1,o=Math.floor(Math.random()*r);return a.map(((e,t)=>t<2?e:2===t?(e&255<<s-8)+(o>>8&255):(e&255<<s)+(255&o))).join(".")}inst_addresses.push("127.0.0.1:1234#CFnat");let l=1;if(t.includes("worker")||t.includes("notls")){const d=inst_httpPorts.concat("80");inst_addressesnotls.push(...c.map((e=>i(e)+":"+d[Math.floor(Math.random()*d.length)]+"#CF Random Node"+String(l++).padStart(2,"0"))))}else{const u=inst_httpsPorts.concat("443");inst_addresses.push(...c.map((e=>i(e)+":"+u[Math.floor(Math.random()*u.length)]+"#CF Random Node"+String(l++).padStart(2,"0"))))}}if(a.toLowerCase().includes("mozilla")&&!["sub","base64","b64","clash","singbox","sb"].some((e=>s.searchParams.has(e)))){return config_Html(getGeoInfo(o))}return""}function config_Html(e){return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title id="pageTitle">Service Configuration</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">\n</head>\n<body style="font-family: 'Noto Sans SC', sans-serif; background-color: #f4f7f9; color: #333333; line-height: 1.7;">\n    <div class="container py-4">\n        <div class="card mb-4 rounded-3 shadow position-relative">\n            <div class="card-body text-center p-4">\n                <h1 id="pageHeader" class="display-4 fw-bold text-primary mb-0">üîß Service Configuration</h1>\n            </div>\n        </div>\n        <div id="loading" class="d-flex flex-column align-items-center justify-content-center min-vh-50 text-muted">\n            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>\n            <p>Loading configuration information...</p>\n        </div>\n        <div id="content" class="d-none">\n            <div class="row g-4">\n                <div class="col-12">\n                    <div class="accordion" id="configAccordion">\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">‚öôÔ∏è Configuration Details</button>\n                            </h2>\n                            <div id="configCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light">\n                                    <div class="d-flex flex-column gap-2" id="configInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="accordion-item">\n                            <h2 class="accordion-header">\n                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#linkCollapse">üîó Links</button>\n                            </h2>\n                            <div id="linkCollapse" class="accordion-collapse collapse" data-bs-parent="#configAccordion">\n                                <div class="accordion-body bg-light p-0">\n                                    <div class="p-3" id="linkInfo"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n             <div class="card mt-4">\n                <div class="card-header"><h5 class="mb-0">üìç Connection Information</h5></div>\n                <div class="card-body">${e?generateGeoHTML(e,!1):""}</div>\n            </div>\n        </div>\n    </div>\n    <div class="text-center py-3 mt-4 text-muted small border-top"><p id="userAgent"></p></div>\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"><\/script>\n    <script>\n        let configData = null;\n        document.addEventListener('DOMContentLoaded', function() { loadConfig(); });\n        async function loadConfig() {\n            try {\n                const response = await fetch(window.location.pathname + '/config.json?t=' + Date.now());\n                if (!response.ok) throw new Error('HTTP error! status: ' + response.status);\n                configData = await response.json();\n                document.getElementById('loading').classList.add('d-none');\n                document.getElementById('content').classList.remove('d-none');\n                renderLinkInfo(); renderConfigInfo(); updatePageTitles();\n                document.getElementById('userAgent').textContent = 'User-Agent: ' + configData.UA;\n            } catch (error) { console.error('Configuration loading failed:', error); }\n        }\n        function renderLinkInfo() {\n            const container = document.getElementById('linkInfo');\n            const v2Link = configData.link.v2;\n            const v2Card = document.createElement('div');\n            v2Card.className = 'card border-start border-success border-3 p-3 mb-3';\n            v2Card.innerHTML = '<div class="fw-bold text-success h5 mb-2">v2 Link</div>' + '<div class="small monospace bg-light p-2 rounded" style="word-break: break-all; cursor: pointer;">' + v2Link + '</div>';\n            v2Card.querySelector('.bg-light').addEventListener('click', () => copyText(v2Link));\n            container.innerHTML = '';\n            container.appendChild(v2Card);\n        }\n        function renderConfigInfo() {\n            const container = document.getElementById('configInfo');\n            const config = configData.config;\n            let configItems = [{ label: 'HOST', value: config.HOST }, { label: 'UUID', value: config.KEY.UUID }, { label: 'Skip TLS Verify', value: config.SCV === 'true' ? '‚úÖ Enabled' : '‚ùå Disabled' }];\n            container.innerHTML = configItems.map(item => ('<div class="bg-light rounded p-2 border-start border-primary border-3"><div class="small text-muted fw-medium mb-1">' + item.label + '</div><div class="small fw-semibold monospace">' + item.value + '</div></div>')).join('');\n        }\n        function updatePageTitles() {\n            const subName = configData.sub.SUBNAME;\n            if (subName) {\n                document.getElementById('pageTitle').textContent = subName + ' Configuration';\n                document.getElementById('pageHeader').textContent = 'üîß ' + subName + ' Service Configuration';\n            }\n        }\n        function copyText(text) {\n            navigator.clipboard.writeText(text).then(() => { showToast('‚úÖ Copied to clipboard'); }).catch(err => { console.error('Copy failed:', err); showToast('‚ùå Copy failed'); });\n        }\n        function showToast(message, duration = 3000) {\n            const toast = document.createElement('div');\n            toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);';\n            toast.textContent = message;\n            document.body.appendChild(toast);\n            setTimeout(() => { toast.remove(); }, duration);\n        }\n    <\/script>\n</body>\n</html>`}

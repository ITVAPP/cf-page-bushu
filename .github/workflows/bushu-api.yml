name: Cloudflare Pages Deploy Api
on:
  workflow_dispatch:
    inputs:
      deploy_configs:
        description: '部署配置JSON'
        required: true
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 3

  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Parse configs
        id: parse
        run: |
          CONFIGS='${{ github.event.inputs.deploy_configs }}'
          if [[ "$CONFIGS" == \[* ]]; then
            echo "configs=$CONFIGS" >> $GITHUB_OUTPUT
          else
            echo "configs=[$CONFIGS]" >> $GITHUB_OUTPUT
          fi
      
      # 预安装 Wrangler CLI，避免循环内重复 npx 检查
      - name: Install Wrangler
        run: npm install -g wrangler@3
      
      - name: Deploy
        env:
          DEPLOY_CONFIGS: ${{ steps.parse.outputs.configs }}
        run: |
          # 静默更新源并安装 jq（隐藏所有 Get/Hit 输出）
          sudo apt-get update -qq > /dev/null 2>&1 && sudo apt-get install -y jq
          
          CONFIGS=$(echo "$DEPLOY_CONFIGS" | jq -c '.[]')
          TOTAL=$(echo "$DEPLOY_CONFIGS" | jq '. | length')
          CURRENT=0
          SUCCESS=0
          FAILED=0
          
          echo "🚀 将部署 $TOTAL 个项目"
          
          while IFS= read -r config; do
            CURRENT=$((CURRENT + 1))
            
            API_TOKEN=$(echo "$config" | jq -r '.apiToken')
            ACCOUNT_ID=$(echo "$config" | jq -r '.accountId')
            PROJECT_NAME=$(echo "$config" | jq -r '.projectName')
            
            echo "[$CURRENT/$TOTAL] 部署: $PROJECT_NAME"
            
            export CLOUDFLARE_API_TOKEN="$API_TOKEN"
            export CLOUDFLARE_ACCOUNT_ID="$ACCOUNT_ID"
            
            LOG_FILE="/tmp/deploy_$(date +%s).log"
            wrangler pages deploy . --project-name="$PROJECT_NAME" --branch=main > "$LOG_FILE" 2>&1
            
            # 检查日志中是否包含部署成功的标志
            if grep -q "Deployment complete" "$LOG_FILE"; then
              echo "✅ $PROJECT_NAME 成功"
              SUCCESS=$((SUCCESS + 1))
              grep "Deployment complete" "$LOG_FILE"
            else
              echo "❌ $PROJECT_NAME 失败"
              cat "$LOG_FILE"  # 输出详细错误日志便于排查
              FAILED=$((FAILED + 1))
            fi
            
            rm -f "$LOG_FILE"
            
            # 移除固定 sleep 3 延迟
            # Wrangler CLI 内置了 API 速率限制处理和自动重试机制
            # 串行部署不存在并发冲突，此延迟为不必要的时间浪费
          done <<< "$CONFIGS"
          
          echo "📊 成功: $SUCCESS | 失败: $FAILED"
          
          # 只有真正失败时才退出码 1
          if [ $FAILED -gt 0 ]; then
            exit 1
          else
            exit 0
          fi

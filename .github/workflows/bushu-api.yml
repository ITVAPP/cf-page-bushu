name: Cloudflare Pages Deploy Api
on:
  workflow_dispatch:
    inputs:
      deploy_configs:
        description: 'ÈÉ®ÁΩ≤ÈÖçÁΩÆJSON'
        required: true
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 3

  deploy:
    runs-on: ubuntu-latest
    needs: cleanup
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Parse configs
        id: parse
        run: |
          CONFIGS='${{ github.event.inputs.deploy_configs }}'
          if [[ "$CONFIGS" == \[* ]]; then
            echo "configs=$CONFIGS" >> $GITHUB_OUTPUT
          else
            echo "configs=[$CONFIGS]" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy
        env:
          DEPLOY_CONFIGS: ${{ steps.parse.outputs.configs }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          
          CONFIGS=$(echo "$DEPLOY_CONFIGS" | jq -c '.[]')
          TOTAL=$(echo "$DEPLOY_CONFIGS" | jq '. | length')
          CURRENT=0
          SUCCESS=0
          FAILED=0
          
          echo "üöÄ Â∞ÜÈÉ®ÁΩ≤ $TOTAL ‰∏™È°πÁõÆ"
          
          while IFS= read -r config; do
            CURRENT=$((CURRENT + 1))
            
            API_TOKEN=$(echo "$config" | jq -r '.apiToken')
            ACCOUNT_ID=$(echo "$config" | jq -r '.accountId')
            PROJECT_NAME=$(echo "$config" | jq -r '.projectName')
            
            echo "[$CURRENT/$TOTAL] ÈÉ®ÁΩ≤: $PROJECT_NAME"
            
            export CLOUDFLARE_API_TOKEN="$API_TOKEN"
            export CLOUDFLARE_ACCOUNT_ID="$ACCOUNT_ID"
            
            if npx --yes wrangler@3 pages deploy . --project-name="$PROJECT_NAME" --branch=main; then
              echo "‚úÖ $PROJECT_NAME ÊàêÂäü"
              SUCCESS=$((SUCCESS + 1))
            else
              echo "‚ùå $PROJECT_NAME Â§±Ë¥•"
              FAILED=$((FAILED + 1))
            fi
            
            [ $CURRENT -lt $TOTAL ] && sleep 3
          done <<< "$CONFIGS"
          
          echo "üìä ÊàêÂäü: $SUCCESS | Â§±Ë¥•: $FAILED"
